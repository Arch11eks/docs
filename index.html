<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fuel Finder ‚Äî –±–ª–∏–∂–∞–π—à–∏–µ –∏ –¥–µ—à—ë–≤—ã–µ –ê–ó–°</title>
  <meta name="description" content="–ü–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –Ω–∞ —Ç–æ–ø–ª–∏–≤–æ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º –∏ –≥–æ—Ä–æ–¥–∞–º (LV/LT/EE) –∏ –±–ª–∏–∂–∞–π—à–∏–µ –ê–ó–° –ø–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏."/>
  <style>
    :root{
      --bg:#0f0f10; --card:#15161a; --border:#26282d; --muted:#9aa0a6; --text:#e9eaee;
      --btn:#1a73e8; --btn-text:#fff; --item:#121317; --ok:#22c55e; --err:#ef4444;
      --accent:#4da3ff; --nearby:#10b981;
    }
    body.tg-dark{ --bg:#0b0e11; --card:#111418; --border:#1e2228; --muted:#8f98a3; --text:#e6e9ef; --item:#0f1318; --btn:#5e9bff; --nearby:#16a34a; }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
      font:14px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    a{ color:var(--accent); text-decoration:none }
    .wrap{ max-width:960px; margin:24px auto; padding:0 16px; }
    h1{ font-size:22px; margin:0 0 12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    select,button{ width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--border); background:#101114; color:var(--text); outline:none; }
    select:disabled{ opacity:.6; }
    .grid{ display:grid; grid-template-columns:1fr 1fr 1fr 120px; gap:10px; }
    .row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 220px; }
    .btn{ background:var(--btn); color:var(--btn-text); font-weight:600; border:0; cursor:pointer; transition:filter .15s ease; }
    .btn.secondary{ background:#20242c; color:var(--text); border:1px solid var(--border); }
    .btn.nearby{ background:var(--nearby); }
    .btn:hover{ filter:brightness(1.05) }
    .status{ margin-top:8px; color:var(--muted); min-height:18px; }
    .list{ margin-top:14px; display:grid; gap:10px; }
    .item{ background:var(--item); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .muted{ color:var(--muted); }
    .price{ font-weight:700; }
    .ok{ color:var(--ok); }
    .err{ color:var(--err); }
    .footer{ margin:18px 0 32px; color:var(--muted); font-size:12px; text-align:center; }

    .mapish{ display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;
      border:1px dashed var(--border); border-radius:12px; padding:10px; background:#0e1014; }
    .mapish:hover{ background:#0f1218 }
    .mapish .pin{ font-size:26px; line-height:1 }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
      background:#0f151d; border:1px solid var(--border); font-size:12px; color:var(--muted); }

    @media (max-width:780px){
      .grid{ grid-template-columns:1fr 1fr; }
    }
  </style>
  <!-- Telegram WebApp SDK (–±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –≤—Å–µ–≥–¥–∞) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>‚õΩ Fuel Finder</h1>

    <div class="card">
      <div class="grid">
        <div>
          <label for="country">–°—Ç—Ä–∞–Ω–∞</label>
          <select id="country"></select>
        </div>
        <div>
          <label for="city">–ì–æ—Ä–æ–¥</label>
          <select id="city"><option value="">–í—Å–µ</option></select>
        </div>
        <div>
          <label for="fuel">–¢–æ–ø–ª–∏–≤–æ</label>
          <select id="fuel">
            <option>95</option><option>98</option><option>diesel</option><option>lpg</option>
          </select>
        </div>
        <div>
          <label for="limit">–õ–∏–º–∏—Ç</label>
          <select id="limit"><option>10</option><option selected>20</option><option>50</option></select>
        </div>
      </div>

      <div class="row">
        <button id="apply" class="btn">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button id="nearby" class="btn nearby">üìç –ù–∞–π—Ç–∏ —Ä—è–¥–æ–º</button>
        <button id="send" class="btn secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
      </div>

      <div class="row">
        <div class="mapish" id="mapish" title="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ª–æ–∫–∞—Ü–∏–µ–π –∏ –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–µ –ê–ó–°">
          <span class="pin">üó∫Ô∏è</span>
          <div>
            <div><b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ª–æ–∫–∞—Ü–∏–µ–π</b></div>
            <div class="muted">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ –∑–∞–ø—Ä–∞–≤–∫–∏</div>
          </div>
        </div>
        <div class="chip" id="lastGeoChip" style="display:none"></div>
      </div>

      <div id="status" class="status">–ì–æ—Ç–æ–≤–æ</div>
    </div>

    <div id="list" class="list"></div>

    <div class="footer">
      –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç¬ª –ø–µ—Ä–µ–¥–∞—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –±–æ—Ç—É.
    </div>
  </div>

<script>
(() => {
  // === –ù–ê–°–¢–†–û–ô–ö–ò ===
  const API_BASE = "https://et14k9zlk8.execute-api.eu-north-1.amazonaws.com"; // –µ—Å–ª–∏ —É —Ç–µ–±—è stage prod: –¥–æ–±–∞–≤—å /prod
  const els = {
    country: document.getElementById('country'),
    city:    document.getElementById('city'),
    fuel:    document.getElementById('fuel'),
    limit:   document.getElementById('limit'),
    apply:   document.getElementById('apply'),
    nearby:  document.getElementById('nearby'),
    send:    document.getElementById('send'),
    mapish:  document.getElementById('mapish'),
    list:    document.getElementById('list'),
    status:  document.getElementById('status'),
    lastGeo: document.getElementById('lastGeoChip'),
  };

  // Telegram WebApp –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–Ω–µ –º–µ—à–∞–µ—Ç –≤–Ω–µ Telegram)
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) {
    try { tg.ready(); tg.expand(); if (tg.colorScheme === 'dark') document.body.classList.add('tg-dark'); } catch {}
  }

  // === –£–¢–ò–õ–ò–¢–´ ===
  async function fetchJSON(url) {
    const r = await fetch(url, { mode: 'cors' });
    if (!r.ok) {
      let text = await r.text().catch(()=>String(r.status));
      throw new Error(`${r.status} ${r.statusText}: ${text}`);
    }
    return r.json();
  }
  function setStatus(msg, cls='') { els.status.textContent = msg; els.status.className = 'status ' + (cls||''); }
  function saveState(){
    localStorage.setItem('fuelFinderState', JSON.stringify({
      c: els.country.value, ci: els.city.value, f: els.fuel.value, l: els.limit.value
    }));
  }
  function restoreState(){
    try{ return JSON.parse(localStorage.getItem('fuelFinderState') || '{}'); }catch{ return {}; }
  }
  function setLastGeo(lat, lon){
    if (lat == null || lon == null) { els.lastGeo.style.display='none'; return; }
    els.lastGeo.style.display='inline-flex';
    els.lastGeo.textContent = `–ü–æ—Å–ª–µ–¥–Ω—è—è –ª–æ–∫–∞—Ü–∏—è: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
  }

  // === –ó–ê–ì–†–£–ó–ö–ê –§–ò–õ–¨–¢–†–û–í ===
  async function loadCountries() {
    setStatus('–ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–∞–Ω—ã‚Ä¶');
    els.country.disabled = true;
    els.country.innerHTML = `<option value="">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option>`;
    try {
      const j = await fetchJSON(`${API_BASE}/meta`);
      const countries = j.countries || [];
      els.country.innerHTML = countries.map(c => `<option>${c}</option>`).join('');
      const saved = restoreState();
      if (saved.c && countries.includes(saved.c)) els.country.value = saved.c;
      await onCountryChange(saved.ci);
      setStatus('–ì–æ—Ç–æ–≤–æ');
    } catch (e) {
      console.error(e);
      setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω', 'err');
      els.country.innerHTML = `<option value="">–û—à–∏–±–∫–∞</option>`;
    } finally {
      els.country.disabled = false;
    }
  }

  async function onCountryChange(prefCity) {
    const c = els.country.value;
    setStatus('–ó–∞–≥—Ä—É–∂–∞—é –≥–æ—Ä–æ–¥–∞‚Ä¶');
    els.city.disabled = true;
    els.city.innerHTML = `<option value="">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option>`;
    try {
      const j = await fetchJSON(`${API_BASE}/meta?country=${encodeURIComponent(c)}`);
      const cities = j.cities || [];
      els.city.innerHTML = `<option value="">–í—Å–µ</option>` + cities.map(ci => `<option>${ci}</option>`).join('');
      if (prefCity && cities.includes(prefCity)) els.city.value = prefCity;
      setStatus('–ì–æ—Ç–æ–≤–æ');
    } catch (e) {
      console.error(e);
      setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤', 'err');
      els.city.innerHTML = `<option value="">–û—à–∏–±–∫–∞</option>`;
    } finally {
      els.city.disabled = false;
    }
  }

  // === –ü–û–ò–°–ö –ü–û –§–ò–õ–¨–¢–†–ê–ú ===
  async function applyFilters() {
    setStatus('–ò—â—É‚Ä¶');
    els.list.innerHTML = '';
    const qs = new URLSearchParams({
      country: els.country.value || '',
      city:    els.city.value || '',
      fuel:    els.fuel.value || '95',
      limit:   els.limit.value || 20,
    });
    try {
      const j = await fetchJSON(`${API_BASE}/search?` + qs.toString());
      setStatus(`–ù–∞–π–¥–µ–Ω–æ: ${j.items.length}`);
      renderList(j.items);
      saveState();
    } catch (e) {
      console.error(e);
      setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', 'err');
      els.list.innerHTML = `<div class="item"><span class="muted">${String(e).slice(0, 240)}</span></div>`;
    }
  }

  function renderList(items) {
    if (!items.length) { els.list.innerHTML = '<div class="item"><span class="muted">–ü—É—Å—Ç–æ</span></div>'; return; }
    els.list.innerHTML = items.map((it, i) => {
      const price = (it.price != null) ? Number(it.price).toFixed(3) : '‚Äî';
      const loc = [it.country, it.city].filter(Boolean).join(' ¬∑ ');
      const q = encodeURIComponent(`${it.name} ${it.address||''} ${it.city||''} ${it.country||''}`);
      const gmaps = `https://maps.google.com/?q=${q}`;
      return `
        <div class="item">
          <div><b>${i+1}. ${it.name}</b> ‚Äî <span class="price">${price} ‚Ç¨/–ª</span></div>
          <div class="muted">${loc}</div>
          <div class="muted">${it.address || ''}</div>
          <div><a href="${gmaps}" target="_blank" rel="noopener" class="muted">–û—Ç–∫—Ä—ã—Ç—å –≤ –∫–∞—Ä—Ç–∞—Ö</a></div>
        </div>
      `;
    }).join('');
  }

  // === –ü–û–ò–°–ö –†–Ø–î–û–ú ===
  function renderListWithDistance(items){
    if (!items.length){ els.list.innerHTML = '<div class="item"><span class="muted">–ü—É—Å—Ç–æ</span></div>'; return; }
    els.list.innerHTML = items.map((it,i)=>{
      const price = (it.price!=null)? Number(it.price).toFixed(3) : '‚Äî';
      const loc = [it.country, it.city].filter(Boolean).join(' ¬∑ ');
      const q = encodeURIComponent(`${it.name} ${it.address||''} ${it.city||''} ${it.country||''}`);
      const gmaps = `https://maps.google.com/?q=${q}`;
      const dist = (it.distance_km!=null)? ` ¬∑ ${Number(it.distance_km).toFixed(1)} –∫–º` : '';
      return `
        <div class="item">
          <div><b>${i+1}. ${it.name}</b> ‚Äî <span class="price">${price} ‚Ç¨/–ª</span></div>
          <div class="muted">${loc}${dist}</div>
          <div class="muted">${it.address || ''}</div>
          <div><a href="${gmaps}" target="_blank" rel="noopener" class="muted">–û—Ç–∫—Ä—ã—Ç—å –≤ –∫–∞—Ä—Ç–∞—Ö</a></div>
        </div>`;
    }).join('');
  }

  async function findNearby(){
    if (!navigator.geolocation){
      setStatus('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º', 'err'); return;
    }
    setStatus('–ü–æ–ª—É—á–∞—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é‚Ä¶');
    navigator.geolocation.getCurrentPosition(async pos=>{
      const { latitude, longitude } = pos.coords;
      setStatus('–ò—â—É –±–ª–∏–∂–∞–π—à–∏–µ‚Ä¶');
      const qs = new URLSearchParams({
        lat: latitude, lon: longitude,
        fuel: els.fuel.value || '95',
        limit: els.limit.value || 20
      });
      try{
        const j = await fetchJSON(`${API_BASE}/nearby?`+qs.toString());
        setStatus(`–ù–∞–π–¥–µ–Ω–æ —Ä—è–¥–æ–º: ${j.items.length}`);
        renderListWithDistance(j.items);
        localStorage.setItem('fuelFinderLastGeo', JSON.stringify({lat:latitude, lon:longitude}));
        setLastGeo(latitude, longitude);
      }catch(e){
        console.error(e);
        setStatus('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ä—è–¥–æ–º', 'err');
      }
    }, err=>{
      setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é: '+err.message, 'err');
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
  }

  // === –û–¢–ü–†–ê–í–ö–ê –í –ß–ê–¢ –¢–ï–õ–ï–ì–†–ê–ú ===
  function sendToBot() {
    if (!tg || !tg.sendData) {
      setStatus('–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç', 'err'); return;
    }
    const payload = {
      country: els.country.value || '',
      city:    els.city.value || '',
      fuel:    (els.fuel.value || '95').toLowerCase()
    };
    try { tg.sendData(JSON.stringify(payload)); setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ‚úî', 'ok'); }
    catch (e) { console.error(e); setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç', 'err'); }
  }

  // === –°–æ–±—ã—Ç–∏—è ===
  els.country.addEventListener('change', () => { onCountryChange(''); });
  els.apply.addEventListener('click', applyFilters);
  els.nearby.addEventListener('click', findNearby);
  els.mapish.addEventListener('click', findNearby);
  els.send.addEventListener('click', sendToBot);

  // === –°—Ç–∞—Ä—Ç ===
  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –≤—ã–±–æ—Ä —Ç–æ–ø–ª–∏–≤–∞/–ª–∏–º–∏—Ç–∞ –∏ –ø–æ–∫–∞–∂–µ–º —á–∏–ø —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π
  const saved = restoreState();
  if (saved.f) els.fuel.value = saved.f;
  if (saved.l) els.limit.value = saved.l;
  try {
    const g = JSON.parse(localStorage.getItem('fuelFinderLastGeo')||'{}');
    if (g.lat!=null && g.lon!=null) setLastGeo(g.lat, g.lon);
  } catch {}
  loadCountries().then(applyFilters);
})();
</script>
</body>
</html>
