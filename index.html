<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fuel Finder ‚Äî –ê–ó–° ¬∑ –ú–∞—Ä—à—Ä—É—Ç ¬∑ –ú–æ–π –∞–≤—Ç–æ</title>
  <style>
    :root{
      --bg: linear-gradient(135deg,#0f0f23 0%,#1a1a2e 100%);
      --card: rgba(255,255,255,.08);
      --card-hover: rgba(255,255,255,.12);
      --border: rgba(255,255,255,.1);
      --border-hover: rgba(255,255,255,.2);
      --muted:#9ca3af; --text:#f8fafc; --accent:#3b82f6; --accent-hover:#2563eb;
      --success:#10b981; --error:#ef4444;
      --nearby: linear-gradient(135deg,#10b981 0%,#059669 100%);
      --primary: linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);
      --secondary: rgba(255,255,255,.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,.3), 0 2px 4px -1px rgba(0,0,0,.2);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.3), 0 4px 6px -2px rgba(0,0,0,.2);
    }
    body.tg-dark{ --bg:linear-gradient(135deg,#0a0a1a 0%,#151529 100%); --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.08); --muted:#8b92a8 }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;line-height:1.6;min-height:100vh}
    h1{font-size:26px;margin:0 0 18px;background:linear-gradient(135deg,var(--text),var(--muted));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .wrap{max-width:1200px;margin:0 auto;padding:20px 14px 100px}
    .card{background:var(--card);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:var(--shadow);transition:.25s}
    .card:hover{background:var(--card-hover);border-color:var(--border-hover);box-shadow:var(--shadow-lg)}
    label{display:block;font-size:12px;font-weight:700;margin:0 0 8px;text-transform:uppercase}
    select,input,button,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--secondary);color:var(--text)}
    select:focus,input:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    button{cursor:pointer;font-weight:700;border:none;position:relative;overflow:hidden}
    .btn{background:var(--primary);color:#fff}
    .btn.nearby{background:var(--nearby)}
    .btn.secondary{background:var(--secondary);color:var(--text);border:1px solid var(--border)}
    .grid{display:grid;gap:14px}
    .grid-st{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .grid-car{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .row>*{flex:1 1 220px}
    .list{margin-top:16px;display:grid;gap:12px}
    .item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .item-title{font-weight:800}
    .item-price{font-weight:900;color:var(--success)}
    .muted{color:var(--muted)}
    .status{margin-top:10px;padding:10px 12px;border-radius:12px;background:var(--secondary);border:1px solid var(--border)}
    .status.ok{border-color:var(--success);color:var(--success);background:rgba(16,185,129,.08)}
    .status.err{border-color:var(--error);color:var(--error);background:rgba(239,68,68,.08)}
    .links{display:flex;gap:10px;margin-top:8px}
    .icon-btn{display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:12px;background:var(--secondary);border:1px solid var(--border)}
    .icon-btn img{width:22px;height:22px;object-fit:contain}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--secondary);color:var(--muted)}
    .tabbar{position:fixed;left:0;right:0;bottom:0;background:var(--card);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100}
    .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 6px;color:var(--muted);cursor:pointer}
    .tab.active{color:var(--text);font-weight:800}
    .screen{display:none}.screen.active{display:block}
    @media (max-width:768px){.grid-st{grid-template-columns:1fr}.grid-car{grid-template-columns:1fr}}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">

  <!-- –°–¢–ê–ù–¶–ò–ò -->
  <div id="screen-stations" class="screen active">
    <h1>‚õΩ –°—Ç–∞–Ω—Ü–∏–∏</h1>
    <div class="card">
      <div class="grid grid-st">
        <div><label for="country">–°—Ç—Ä–∞–Ω–∞</label><select id="country"></select></div>
        <div><label for="city">–ì–æ—Ä–æ–¥</label><select id="city"><option value="">–í—Å–µ</option></select></div>
        <div>
          <label for="brand">–ë—Ä–µ–Ω–¥—ã</label>
          <select id="brand" multiple size="4"></select>
          <small class="muted">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ</small>
        </div>
        <div><label for="fuel">–¢–æ–ø–ª–∏–≤–æ</label><select id="fuel"><option>95</option><option>98</option><option>diesel</option><option>lpg</option></select></div>
        <div>
          <label for="fresh">–°–≤–µ–∂–µ—Å—Ç—å</label>
          <select id="fresh" multiple size="4">
            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="yesterday">–í—á–µ—Ä–∞</option>
            <option value="daybefore">–ü–æ–∑–∞–≤—á–µ—Ä–∞</option>
            <option value="other">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>
        <div><label for="limit">–õ–∏–º–∏—Ç</label><select id="limit"><option>10</option><option selected>20</option><option>50</option></select></div>
      </div>

      <div class="row">
        <button id="apply" class="btn">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button id="nearby" class="btn nearby">–ù–∞–π—Ç–∏ —Ä—è–¥–æ–º</button>
        <button id="send" class="btn secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
      </div>

      <div class="row" id="geoRow" style="display:none"><div class="pill" id="lastGeoChip"></div></div>
      <div id="status" class="status">–ì–æ—Ç–æ–≤–æ</div>
    </div>

    <div id="list" class="list"></div>
  </div>

  <!-- –ú–ê–†–®–†–£–¢ -->
  <div id="screen-route" class="screen">
    <h1>üß≠ –ú–∞—Ä—à—Ä—É—Ç</h1>
    <div class="card">
      <div class="grid grid-car">
        <div>
          <label for="route_from">–û—Ç–∫—É–¥–∞</label>
          <input id="route_from" placeholder="–ê–¥—Ä–µ—Å (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ú–æ—è –ª–æ–∫–∞—Ü–∏—è¬ª)">
          <div class="row"><button id="route_use_geo" class="btn secondary" style="max-width:220px">–ú–æ—è –ª–æ–∫–∞—Ü–∏—è</button></div>
        </div>
        <div>
          <label for="route_to">–ö—É–¥–∞</label>
          <input id="route_to" placeholder="–ê–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" />
        </div>
        <div>
          <label for="route_liters">–°–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–∞–≤–∏—Ç—å (–ª)</label>
          <input id="route_liters" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 20"/>
        </div>
        <div>
          <label for="route_fuel">–¢–æ–ø–ª–∏–≤–æ</label>
          <select id="route_fuel"><option>95</option><option>98</option><option>diesel</option><option>lpg</option></select>
        </div>
      </div>
      <div class="row">
        <button id="route_calc" class="btn">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
      </div>
      <div id="route_status" class="status">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –æ–±—ä—ë–º –∑–∞–ø—Ä–∞–≤–∫–∏</div>
    </div>

    <div id="route_result" class="list"></div>
  </div>

  <!-- –ú–û–ô –ê–í–¢–û -->
  <div id="screen-car" class="screen">
    <h1>üöó –ú–æ–π –∞–≤—Ç–æ</h1>
    <div class="card">
      <div class="grid grid-car">
        <div><label for="car_fuel_type">–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞</label>
          <select id="car_fuel_type"><option>95</option><option>98</option><option>diesel</option><option>lpg</option></select>
        </div>
        <div><label for="car_consumption">–†–∞—Å—Ö–æ–¥ (–ª/100 –∫–º)</label><input id="car_consumption" type="number" step="0.1" min="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 7.5"></div>
        <div><label for="car_tank">–û–±—ä—ë–º –±–∞–∫–∞ (–ª)</label><input id="car_tank" type="number" step="1" min="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 50"></div>
      </div>

      <div style="margin-top:14px">
        <label>–°–∫–∏–¥–∫–∏ –ø–æ –±—Ä–µ–Ω–¥–∞–º (‚Ç¨/–ª)</label>
        <div id="discList" class="list"></div>
        <div class="row">
          <button id="discAdd" class="btn secondary" style="max-width:220px">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          <span class="muted" style="align-self:center">–ù–∞–ø—Ä., 0.04 = 4 —Ü–µ–Ω—Ç–∞ –∑–∞ –ª–∏—Ç—Ä</span>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="carSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="carApplyToFilters" class="btn secondary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º</button>
      </div>
      <div id="carStatus" class="status">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ</div>
    </div>
  </div>
</div>

<!-- –¢–∞–±–±–∞—Ä -->
<div class="tabbar">
  <div id="tabStations" class="tab active"><div>‚õΩ</div><small>–°—Ç–∞–Ω—Ü–∏–∏</small></div>
  <div id="tabRoute" class="tab"><div>üß≠</div><small>–ú–∞—Ä—à—Ä—É—Ç</small></div>
  <div id="tabCar" class="tab"><div>üöó</div><small>–ú–æ–π –∞–≤—Ç–æ</small></div>
</div>

<script>
(() => {
  const API_BASE = "https://et14k9zlk8.execute-api.eu-north-1.amazonaws.com";
  const ASSETS = { maps: "maps.png", waze: "waze.png" }; // –ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª—ã –≤ /assets
  const tg = window.Telegram?.WebApp || null;
  if (tg){ try{ tg.ready(); tg.expand(); if(tg.colorScheme==='dark') document.body.classList.add('tg-dark'); }catch{} }

  // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞/–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç ---
  let LAST_MODE = 'search';  // 'search' | 'nearby' | 'route'
  let LAST_ITEMS = [];
  let LAST_GEO = null;

  const els = {
    // stations
    country:$('#country'), city:$('#city'), brand:$('#brand'), fuel:$('#fuel'),
    fresh:$('#fresh'), limit:$('#limit'), apply:$('#apply'), nearby:$('#nearby'),
    send:$('#send'), list:$('#list'), status:$('#status'), lastGeo:$('#lastGeoChip'), geoRow:$('#geoRow'),
    // route
    routeFrom:$('#route_from'), routeTo:$('#route_to'), routeLiters:$('#route_liters'), routeFuel:$('#route_fuel'),
    routeUseGeo:$('#route_use_geo'), routeCalc:$('#route_calc'), routeStatus:$('#route_status'), routeResult:$('#route_result'),
    // car
    carFuel:$('#car_fuel_type'), carCons:$('#car_consumption'), carTank:$('#car_tank'),
    discList:$('#discList'), discAdd:$('#discAdd'), carSave:$('#carSave'), carApply:$('#carApplyToFilters'), carStatus:$('#carStatus'),
    // tabs
    sStations:$('#screen-stations'), sRoute:$('#screen-route'), sCar:$('#screen-car'),
    tStations:$('#tabStations'), tRoute:$('#tabRoute'), tCar:$('#tabCar')
  };
  function $(id){ return document.getElementById(id.replace(/^#/,'')); }
  async function fetchJSON(url, opt){ const r=await fetch(url, opt); if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText)); return r.json(); }
  function setStatus(m,c=''){ els.status.textContent=m; els.status.className='status '+(c||''); }
  function setRouteStatus(m,c=''){ els.routeStatus.textContent=m; els.routeStatus.className='status '+(c||''); }
  function setCarStatus(m,c=''){ els.carStatus.textContent=m; els.carStatus.className='status '+(c||''); }
  function selValues(s){ return Array.from(s.selectedOptions).map(o=>o.value).filter(Boolean); }
  function setOptions(s, arr){ s.innerHTML = arr.map(v=>`<option>${v}</option>`).join(''); }
  function preselect(s, vals){ const set=new Set(vals||[]); Array.from(s.options).forEach(o=>o.selected=set.has(o.value)); }
  function setLastGeo(lat,lon){ if(lat==null||lon==null){ els.geoRow.style.display='none'; return;} els.geoRow.style.display='flex'; els.lastGeo.textContent=`–ü–æ—Å–ª–µ–¥–Ω—è—è –ª–æ–∫–∞—Ü–∏—è: ${lat.toFixed(4)}, ${lon.toFixed(4)}`; }

  // --- user id –∏–∑ Telegram –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è ---
  const UID = (tg?.initDataUnsafe?.user?.id) ? String(tg.initDataUnsafe.user.id) : null;

  // ===== —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ—Ñ–∏–ª—å =====
  async function register(){ if(!UID) return;
    try{ await fetchJSON(`${API_BASE}/user/register`, {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({source:'telegram_webapp', platform_user_id:UID, username:tg?.initDataUnsafe?.user?.username||null})}); }catch{}
  }
  async function loadProfile(){
    if(!UID) return loadMyCarLocal();
    try{
      const p = await fetchJSON(`${API_BASE}/user/profile?uid=${encodeURIComponent(UID)}`);
      if (p && typeof p==='object'){ applyProfileToUI(p); saveMyCarLocal(p); return; }
      loadMyCarLocal();
    }catch{ loadMyCarLocal(); }
  }
  async function saveProfile(p){
    saveMyCarLocal(p); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–æ—Ö—Ä–∞–Ω–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
    if(!UID) return;
    try{ await fetchJSON(`${API_BASE}/user/profile`, {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ uid: UID, profile: p })}); setCarStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úî','ok'); }
    catch(e){ setCarStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)','err'); }
  }

  function saveMyCarLocal(p){ localStorage.setItem('fuelMyCar', JSON.stringify(p)); }
  function loadMyCarLocal(){
    try{ const p = JSON.parse(localStorage.getItem('fuelMyCar')||'{}'); applyProfileToUI(p); }
    catch{ /* noop */ }
  }
  function readProfileFromUI(){ return {
    fuel_type: els.carFuel.value || '95',
    consumption_l_per_100: +els.carCons.value || null,
    tank_capacity_l: +els.carTank.value || null,
    discounts: collectDiscounts(els.discList),
    defaults: { max_detour_min: 5 } // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—ë–º 5 –º–∏–Ω
  }; }
  function applyProfileToUI(p){
    if (!p) return;
    if (p.fuel_type) els.carFuel.value = p.fuel_type;
    if (p.consumption_l_per_100!=null) els.carCons.value = p.consumption_l_per_100;
    if (p.tank_capacity_l!=null) els.carTank.value = p.tank_capacity_l;
    loadDiscounts(els.discList, p.discounts||[]);
    // –ø–æ–¥—Ç—è–Ω–µ–º –≤ –≤–∫–ª–∞–¥–∫—É ¬´–ú–∞—Ä—à—Ä—É—Ç¬ª —Ç–æ–ø–ª–∏–≤–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
    els.routeFuel.value = p.fuel_type || '95';
  }

  // ===== meta =====
  let ALL_BRANDS = [];
  async function loadMeta(){
    setStatus('–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶'); try{
      const m = await fetchJSON(`${API_BASE}/meta`);
      setOptions(els.country, m.countries||[]);
      ALL_BRANDS = m.brands||[];
      fillBrands(ALL_BRANDS);
      setStatus('–ì–æ—Ç–æ–≤–æ','ok');
    }catch(e){ setStatus('–û—à–∏–±–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö','err'); }
  }
  function fillBrands(brands){ els.brand.innerHTML=(brands||[]).map(b=>`<option value="${b}">${b}</option>`).join(''); }
  async function onCountryChange(){
    const c=els.country.value; setStatus('–ì–æ—Ä–æ–¥–∞‚Ä¶');
    try{ const r=await fetchJSON(`${API_BASE}/meta?country=${encodeURIComponent(c)}`); els.city.innerHTML=`<option value="">–í—Å–µ</option>`+(r.cities||[]).map(x=>`<option>${x}</option>`).join(''); setStatus('–ì–æ—Ç–æ–≤–æ',''); }
    catch{ setStatus('–û—à–∏–±–∫–∞ –≥–æ—Ä–æ–¥–æ–≤','err'); }
  }

  // ===== –ø–µ—Ä–µ–≤–æ–¥ —Å–≤–µ–∂–µ—Å—Ç–∏ =====
  const norm = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim();
  function translateFreshLabel(raw){
    const n=norm(raw); if(['sodien','siandien','tana','≈°odien'].includes(n)) return '–°–µ–≥–æ–¥–Ω—è';
    if(['vakar','eile'].includes(n)) return '–í—á–µ—Ä–∞';
    if(['aizvakar','uzvakar','uleeile','ule eile','ule-eile'].includes(n)) return '–ü–æ–∑–∞–≤—á–µ—Ä–∞';
    if(/\d/.test(raw||'')) return raw; return raw||'';
  }
  function classifyFresh(it){
    const n=norm(it.fresh_label||'');
    if(['sodien','siandien','tana','≈°odien'].includes(n)) return 'today';
    if(['vakar','eile'].includes(n)) return 'yesterday';
    if(['aizvakar','uzvakar','uleeile','ule eile','ule-eile'].includes(n)) return 'daybefore';
    if(it.fresh_days===0) return 'today'; if(it.fresh_days===1) return 'yesterday'; if(it.fresh_days===2) return 'daybefore';
    return 'other';
  }
  const freshPass = (it, arr)=> !arr?.length || arr.includes(classifyFresh(it));

  // ===== stations search / nearby =====
  function gmapsDir(it){ return (it.lat!=null && it.lon!=null)
      ? `https://www.google.com/maps/dir/?api=1&destination=${it.lat},${it.lon}&travelmode=driving`
      : `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(`${it.name||''} ${it.address||''} ${it.city||''} ${it.country||''}`)}&travelmode=driving`; }
  function wazeNav(it){ return (it.lat!=null && it.lon!=null)
      ? `https://waze.com/ul?ll=${it.lat},${it.lon}&navigate=yes`
      : `https://waze.com/ul?q=${encodeURIComponent(`${it.name||''} ${it.address||''} ${it.city||''} ${it.country||''}`)}&navigate=yes`; }

  function renderList(items){
    if(!items.length){ els.list.innerHTML='<div class="item muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
    els.list.innerHTML = items.map((it,i)=>{
      const price = it.price!=null?Number(it.price).toFixed(3):'‚Äî';
      const freshTxt = translateFreshLabel(it.fresh_label) || (it.fresh_days!=null ? (it.fresh_days===0?'–°–µ–≥–æ–¥–Ω—è':it.fresh_days===1?'–í—á–µ—Ä–∞':it.fresh_days===2?'–ü–æ–∑–∞–≤—á–µ—Ä–∞':`${it.fresh_days} –¥–Ω. –Ω–∞–∑–∞–¥`) : '');
      const info = [it.brand, it.country, it.city].filter(Boolean).join(' ¬∑ ') + (freshTxt?` ¬∑ ${freshTxt}`:'');
      return `<div class="item">
        <div class="item-title">${i+1}. ${it.name} ‚Äî <span class="item-price">${price} ‚Ç¨/–ª</span></div>
        <div class="muted">${info}</div>
        <div class="muted">${it.address||''}</div>
        <div class="links">
          <a class="icon-btn" href="${gmapsDir(it)}" target="_blank" title="Google Maps"><img src="${ASSETS.maps}" alt="Maps"></a>
          <a class="icon-btn" href="${wazeNav(it)}"  target="_blank" title="Waze"><img src="${ASSETS.waze}"  alt="Waze"></a>
        </div>
      </div>`;
    }).join('');
  }
  function renderListWithDistance(items){
    if(!items.length){ els.list.innerHTML='<div class="item muted">–†—è–¥–æ–º –Ω–∏—á–µ–≥–æ</div>'; return; }
    els.list.innerHTML = items.map((it,i)=>{
      const price = it.price!=null?Number(it.price).toFixed(3):'‚Äî';
      const freshTxt = translateFreshLabel(it.fresh_label) || (it.fresh_days!=null ? (it.fresh_days===0?'–°–µ–≥–æ–¥–Ω—è':it.fresh_days===1?'–í—á–µ—Ä–∞':it.fresh_days===2?'–ü–æ–∑–∞–≤—á–µ—Ä–∞':`${it.fresh_days} –¥–Ω. –Ω–∞–∑–∞–¥`) : '');
      const road = (it.drive_distance_km!=null||it.drive_duration_min!=null) ? ` ¬∑ –ø–æ –¥–æ—Ä–æ–≥–µ: ${it.drive_distance_km?.toFixed?.(1)||'‚Äî'} –∫–º, ${it.drive_duration_min?.toFixed?.(0)||'‚Äî'} –º–∏–Ω` : '';
      const straight = (it.distance_km!=null)?` ¬∑ –ø–æ –ø—Ä—è–º–æ–π: ${Number(it.distance_km).toFixed(1)} –∫–º`:'';
      const info = [it.brand, it.country, it.city].filter(Boolean).join(' ¬∑ ') + (freshTxt?` ¬∑ ${freshTxt}`:'') + road + straight;
      return `<div class="item">
        <div class="item-title">${i+1}. ${it.name} ‚Äî <span class="item-price">${price} ‚Ç¨/–ª</span></div>
        <div class="muted">${info}</div>
        <div class="muted">${it.address||''}</div>
        <div class="links">
          <a class="icon-btn" href="${gmapsDir(it)}" target="_blank"><img src="${ASSETS.maps}"></a>
          <a class="icon-btn" href="${wazeNav(it)}"  target="_blank"><img src="${ASSETS.waze}"></a>
        </div>
      </div>`;
    }).join('');
  }

  async function applyFilters(){
    setStatus('–ò—â—É‚Ä¶'); els.list.innerHTML='';
    const qs = new URLSearchParams({
      country: els.country.value||'', city: els.city.value||'',
      brands: selValues(els.brand).join(','), fuel: els.fuel.value||'95',
      limit: els.limit.value||20
    });
    try{
      const r = await fetchJSON(`${API_BASE}/search?`+qs.toString());
      const want = selValues(els.fresh);
      const lim = parseInt(els.limit.value||20,10);
      let items = (r.items||[]).filter(it=>freshPass(it,want));
      if (items.length>lim) items = items.slice(0,lim);
      LAST_MODE='search'; LAST_ITEMS=items; LAST_GEO=null;
      renderList(items); setStatus(`–ù–∞–π–¥–µ–Ω–æ: ${items.length}`,'ok');
    }catch(e){ setStatus('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: '+e,'err'); }
  }

  async function findNearby(){
    if(!navigator.geolocation){ setStatus('–ù–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏','err'); return; }
    setStatus('–õ–æ–∫–∞—Ü–∏—è‚Ä¶');
    navigator.geolocation.getCurrentPosition(async pos=>{
      const {latitude,longitude}=pos.coords; setStatus('–ò—â—É —Ä—è–¥–æ–º‚Ä¶');
      const qs = new URLSearchParams({
        lat: latitude, lon: longitude, brands: selValues(els.brand).join(','),
        fuel: els.fuel.value||'95', limit: els.limit.value||20, routing: 'drive'
      });
      try{
        const r = await fetchJSON(`${API_BASE}/nearby?`+qs.toString());
        const want = selValues(els.fresh); const lim = parseInt(els.limit.value||20,10);
        let items = (r.items||[]).filter(it=>freshPass(it, want));
        if (items.length>lim) items = items.slice(0,lim);
        LAST_MODE='nearby'; LAST_ITEMS=items; LAST_GEO={lat:latitude,lon:longitude};
        localStorage.setItem('fuelFinderLastGeo', JSON.stringify(LAST_GEO));
        setLastGeo(latitude, longitude);
        renderListWithDistance(items); setStatus(`–†—è–¥–æ–º: ${items.length}`,'ok');
      }catch(e){ setStatus('–û—à–∏–±–∫–∞ —Ä—è–¥–æ–º: '+e,'err'); }
    }, err=> setStatus('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: '+err.message,'err'), {enableHighAccuracy:true,timeout:10000});
  }

  // ===== –º–∞—Ä—à—Ä—É—Ç–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è =====
  els.routeUseGeo.addEventListener('click', ()=>{
    if(!navigator.geolocation){ setRouteStatus('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞','err'); return; }
    navigator.geolocation.getCurrentPosition(
      p => { els.routeFrom.value = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`; setRouteStatus('–õ–æ–∫–∞—Ü–∏—è –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞','ok'); },
      e => setRouteStatus('–û—à–∏–±–∫–∞ –≥–µ–æ: '+e.message,'err'),
      {enableHighAccuracy:true,timeout:10000}
    );
  });

  async function calcRoute(){
    const to = els.routeTo.value.trim();
    const liters = parseFloat(els.routeLiters.value);
    if (!to || !liters || liters<=0){ setRouteStatus('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏ –ª–∏—Ç—Ä—ã','err'); return; }

    const from = els.routeFrom.value.trim(); // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ => —Å–µ—Ä–≤–µ—Ä –≤–æ–∑—å–º—ë—Ç –≥–µ–æ –∏–∑ —Ç–æ–∫–µ–Ω–∞/–Ω–µ –≤–æ–∑—å–º—ë—Ç
    const profile = readProfileFromUI();
    const body = {
      origin: from ? {text: from} : {use_current: true},
      destination: {text: to},
      liters: liters,
      fuel: els.routeFuel.value || profile.fuel_type || '95',
      car: {
        consumption_l_per_100: profile.consumption_l_per_100,
        tank_capacity_l: profile.tank_capacity_l
      },
      max_detour_min: 5, // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏
      discounts: profile.discounts || []
    };

    setRouteStatus('–°—á–∏—Ç–∞—é‚Ä¶');
    try{
      const res = await fetchJSON(`${API_BASE}/route/optimize`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      LAST_MODE='route'; LAST_ITEMS= res.best ? [res.best] : (res.candidates||[]);
      renderRouteResult(res);
      setRouteStatus(res.best ? '–ì–æ—Ç–æ–≤–æ ‚úî' : '–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –ø–æ–∫–∞–∑–∞–Ω—ã','ok');
    }catch(e){
      setRouteStatus('–°–µ—Ä–≤–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç: '+e,'err');
      els.routeResult.innerHTML = '';
    }
  }

  function renderRouteResult(res){
    const best = res.best;
    const cand = res.candidates || [];
    const all = best ? [best, ...cand.filter(x=>x!==best)] : cand;
    if (!all.length){ els.routeResult.innerHTML='<div class="item muted">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>'; return; }
    els.routeResult.innerHTML = all.map((it,i)=>{
      const price = it.price!=null?Number(it.price).toFixed(3):'‚Äî';
      const extra = (it.drive_distance_km!=null||it.drive_duration_min!=null)
        ? ` ¬∑ –æ–±—ä–µ–∑–¥: ${it.drive_distance_km?.toFixed?.(1)||'‚Äî'} –∫–º, ${it.drive_duration_min?.toFixed?.(0)||'‚Äî'} –º–∏–Ω` : '';
      const saving = (it.saving_vs_baseline_eur!=null) ? ` ¬∑ —ç–∫–æ–Ω–æ–º–∏—è: ~${it.saving_vs_baseline_eur.toFixed(2)} ‚Ç¨` : '';
      const total = (it.total_cost_eur!=null) ? ` ¬∑ —á–µ–∫: ~${it.total_cost_eur.toFixed(2)} ‚Ç¨` : '';
      return `<div class="item">
        <div class="item-title">${i===0?'‚≠ê –õ—É—á—à–∏–π: ':''}${it.name} ‚Äî <span class="item-price">${price} ‚Ç¨/–ª</span></div>
        <div class="muted">${[it.brand,it.city,it.country].filter(Boolean).join(' ¬∑ ')}${extra}${saving}${total}</div>
        <div class="muted">${it.address||''}</div>
        <div class="links">
          <a class="icon-btn" href="${gmapsDir(it)}" target="_blank" title="–ú–∞—Ä—à—Ä—É—Ç –≤ Google Maps"><img src="${ASSETS.maps}" alt="Maps"></a>
          <a class="icon-btn" href="${wazeNav(it)}"  target="_blank" title="–ú–∞—Ä—à—Ä—É—Ç –≤ Waze"><img src="${ASSETS.waze}"  alt="Waze"></a>
        </div>
      </div>`;
    }).join('');
  }

  // ===== discounts editor (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π) =====
  function makeDiscRow(brand='',off=''){
    const row=document.createElement('div'); row.className='row';
    const sel=document.createElement('select'); sel.style.maxWidth='260px';
    sel.innerHTML=(ALL_BRANDS||[]).map(b=>`<option>${b}</option>`).join(''); if(brand) sel.value=brand;
    const inp=document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.min='0'; inp.placeholder='0.04'; if(off!==''&&off!=null) inp.value=off;
    const del=document.createElement('button'); del.className='btn secondary'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.style.maxWidth='120px'; del.onclick=()=>row.remove();
    row.append(sel,inp,del); return row;
  }
  function loadDiscounts(el, arr){ el.innerHTML=''; (arr||[]).forEach(d=>el.appendChild(makeDiscRow(d.brand,d.off_eur_per_l))); if(!arr||!arr.length) el.appendChild(makeDiscRow()); }
  function collectDiscounts(el){ const out=[]; el.querySelectorAll('.row').forEach(r=>{ const b=r.querySelector('select')?.value||''; const off=parseFloat(r.querySelector('input')?.value); if(b&&!isNaN(off)&&off>0) out.push({brand:b,off_eur_per_l:+off}); }); return out; }

  // ===== tabs =====
  function switchTab(t){ els.sStations.classList.toggle('active', t==='stations');
    els.sRoute.classList.toggle('active', t==='route'); els.sCar.classList.toggle('active', t==='car');
    els.tStations.classList.toggle('active', t==='stations'); els.tRoute.classList.toggle('active', t==='route'); els.tCar.classList.toggle('active', t==='car'); }
  els.tStations.onclick=()=>switchTab('stations'); els.tRoute.onclick=()=>switchTab('route'); els.tCar.onclick=()=>switchTab('car');

  // ===== events =====
  els.country.onchange = onCountryChange;
  els.apply.onclick = applyFilters;
  els.nearby.onclick = findNearby;
  els.send.onclick = ()=> {
    if(!tg?.sendData){ setStatus('–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram','err'); return; }
    const payload = {
      mode: LAST_MODE,
      filters: {
        country: els.country.value||'', city: els.city.value||'',
        brands: selValues(els.brand), fuel: (els.fuel.value||'95').toLowerCase(),
        fresh: selValues(els.fresh), limit: parseInt(els.limit.value||20,10)
      },
      geo: LAST_GEO,
      preview: (LAST_ITEMS||[]).slice(0,10),
      nonce: Date.now()
    };
    try{ tg.sendData(JSON.stringify(payload)); setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úî','ok'); }catch(e){ setStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏','err'); }
  };

  els.discAdd.onclick = ()=> els.discList.appendChild(makeDiscRow());
  els.carSave.onclick = ()=> saveProfile(readProfileFromUI());
  els.carApply.onclick = ()=> { const p=readProfileFromUI(); saveProfile(p); els.fuel.value = p.fuel_type || '95'; setCarStatus('–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º','ok'); switchTab('stations'); applyFilters(); };

  els.routeCalc.onclick = calcRoute;

  // ===== init =====
  (async ()=>{
    await register();
    await loadMeta();
    await onCountryChange();
    await loadProfile();   // –ø–æ–¥—Ç—è–Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ)
    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≥–µ–æ-–º–µ—Ç–∫—É (–¥–ª—è UI):
    try{ const g=JSON.parse(localStorage.getItem('fuelFinderLastGeo')||'{}'); if(g.lat&&g.lon) setLastGeo(g.lat,g.lon);}catch{}
    applyFilters();
  })();

})();
</script>
</body>
</html>
