<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fuel Finder ‚Äî –ê–ó–° –∏ My Car</title>
  <style>
    :root{ 
      --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
      --card: rgba(255, 255, 255, 0.08);
      --card-hover: rgba(255, 255, 255, 0.12);
      --border: rgba(255, 255, 255, 0.1);
      --border-hover: rgba(255, 255, 255, 0.2);
      --muted: #9ca3af;
      --text: #f8fafc;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --error: #ef4444;
      --nearby: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --primary: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      --secondary: rgba(255, 255, 255, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.3), 0 4px 6px -2px rgba(0,0,0,.2);
    }
    body.tg-dark{ 
      --bg: linear-gradient(135deg, #0a0a1a 0%, #151529 100%);
      --card: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.08);
      --muted: #8b92a8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Inter',sans-serif;
      font-size:14px;line-height:1.6;min-height:100vh;
    }
    a{color:var(--accent);text-decoration:none;transition:color .2s}
    a:hover{color:var(--accent-hover)}
    h1{font-size:28px;font-weight:700;margin:0 0 24px;
      background:linear-gradient(135deg,var(--text) 0%,var(--muted) 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 100px}
    .card{background:var(--card);backdrop-filter:blur(20px);border:1px solid var(--border);
      border-radius:20px;padding:24px;box-shadow:var(--shadow);transition:all .3s;position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent)}
    .card:hover{background:var(--card-hover);border-color:var(--border-hover);box-shadow:var(--shadow-lg);transform:translateY(-2px)}
    label{display:block;font-size:13px;font-weight:600;color:var(--text);margin:0 0 8px;text-transform:uppercase;letter-spacing:.5px}
    select,input,button{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--border);
      background:var(--secondary);color:var(--text);font-size:14px;transition:all .2s;backdrop-filter:blur(10px)}
    select:focus,input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.1);background:rgba(255,255,255,.08)}
    select:disabled,input:disabled{opacity:.5;cursor:not-allowed}
    button{cursor:pointer;font-weight:600;text-transform:uppercase;letter-spacing:.5px;border:none;position:relative;overflow:hidden}
    button::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
    button:hover::before{left:100%}
    .btn-primary{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
    .btn-nearby{background:var(--nearby);color:#fff;box-shadow:var(--shadow)}
    .btn-secondary{background:var(--secondary);color:var(--text);border:1px solid var(--border)}
    .btn-secondary:hover{background:var(--card);border-color:var(--border-hover)}
    .btn-link{background:transparent;color:var(--accent);border:none;padding:8px 0;text-transform:none;letter-spacing:normal}
    .grid{display:grid;gap:20px}
    .grid-stations{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .grid-car{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
    .row{display:flex;gap:16px;margin-top:20px;flex-wrap:wrap}
    .row>*{flex:1;min-width:200px}
    .status{margin-top:16px;padding:12px 16px;border-radius:12px;font-weight:500;min-height:20px;
      backdrop-filter:blur(10px);border:1px solid var(--border);background:var(--secondary)}
    .status.ok{background:rgba(16,185,129,.1);border-color:#10b981;color:#10b981}
    .status.err{background:rgba(239,68,68,.1);border-color:#ef4444;color:#ef4444}
    .list{margin-top:24px;display:grid;gap:16px}
    .item{background:var(--card);backdrop-filter:blur(20px);border:1px solid var(--border);
      border-radius:16px;padding:20px;transition:all .3s;position:relative;overflow:hidden}
    .item::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg,var(--accent),#10b981);transform:scaleX(0);transition:transform .3s}
    .item:hover{background:var(--card-hover);border-color:var(--border-hover);transform:translateY(-4px);box-shadow:var(--shadow-lg)}
    .item:hover::before{transform:scaleX(1)}
    .item-title{font-size:18px;font-weight:700;margin-bottom:8px}
    .item-price{font-size:20px;font-weight:800;color:#10b981;text-shadow:0 0 10px rgba(16,185,129,.3)}
    .item-info{color:var(--muted);margin:8px 0;font-size:13px}
    .links{display:flex;gap:12px;margin-top:16px}
    .icon-btn{display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:12px;
      background:var(--secondary);border:1px solid var(--border);transition:all .2s;backdrop-filter:blur(10px)}
    .icon-btn:hover{background:var(--card);border-color:var(--border-hover);transform:translateY(-2px);box-shadow:var(--shadow)}
    .icon-btn img{width:22px;height:22px;object-fit:contain;display:block}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;background:var(--secondary);
      border:1px solid var(--border);color:var(--muted);font-size:12px;font-weight:500;backdrop-filter:blur(10px)}
    .geo-chip{background:rgba(16,185,129,.1);border-color:#10b981;color:#10b981}
    .discounts{display:grid;gap:12px}
    .disc-row{display:grid;grid-template-columns:1fr 140px 50px;gap:12px;align-items:end}
    .disc-row button{width:50px;height:50px;padding:0;display:flex;align-items:center;justify-content:center;font-size:18px}
    .tabbar{position:fixed;left:0;right:0;bottom:0;background:var(--card);backdrop-filter:blur(20px);
      border-top:1px solid var(--border);display:flex;z-index:100;box-shadow:0 -4px 6px -1px rgba(0,0,0,.1)}
    .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 8px;color:var(--muted);
      cursor:pointer;user-select:none;transition:all .2s;position:relative}
    .tab-btn::before{content:'';position:absolute;top:0;left:20%;right:20%;height:3px;background:var(--accent);
      border-radius:0 0 3px 3px;transform:scaleX(0);transition:transform .3s}
    .tab-btn.active{color:var(--text);font-weight:600}
    .tab-btn.active::before{transform:scaleX(1)}
    .tab-icon{font-size:24px}
    .screen{opacity:0;transform:translateY(20px);transition:all .3s;display:none}
    .screen.active{opacity:1;transform:translateY(0);display:block}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;font-style:italic}
    .footer{margin:32px 0 120px;color:var(--muted);font-size:12px;text-align:center;line-height:1.6}
    @media (max-width:768px){
      .wrap{padding:16px 12px 100px}.card{padding:20px}
      .grid-stations{grid-template-columns:1fr}.grid-car{grid-template-columns:1fr}
      .row{flex-direction:column}.row>*{min-width:unset}.disc-row{grid-template-columns:1fr 100px 44px}
      h1{font-size:24px}
    }
    @media (max-width:480px){
      .wrap{padding:12px 8px 100px}.card{padding:16px}.disc-row{grid-template-columns:1fr 80px 40px}
    }
    .loading{animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">
  <div id="screen-stations" class="screen active">
    <h1>‚õΩ –ü–æ–∏—Å–∫ —Å—Ç–∞–Ω—Ü–∏–π</h1>
    <div class="card">
      <div class="grid grid-stations">
        <div>
          <label for="country">üåç –°—Ç—Ä–∞–Ω–∞</label>
          <select id="country"></select>
        </div>
        <div>
          <label for="city">üèôÔ∏è –ì–æ—Ä–æ–¥</label>
          <select id="city"><option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option></select>
        </div>
        <div>
          <label for="brand">üè¢ –ë—Ä–µ–Ω–¥—ã</label>
          <select id="brand" multiple size="4"></select>
          <div class="hint">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö</div>
        </div>
        <div>
          <label for="fuel">‚õΩ –¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞</label>
          <select id="fuel">
            <option value="95">95 –±–µ–Ω–∑–∏–Ω</option>
            <option value="98">98 –±–µ–Ω–∑–∏–Ω</option>
            <option value="diesel">–î–∏–∑–µ–ª—å</option>
            <option value="lpg">–ì–∞–∑</option>
          </select>
        </div>
        <div>
          <label for="fresh">üìÖ –°–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö</label>
          <select id="fresh" multiple size="4">
            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="yesterday">–í—á–µ—Ä–∞</option>
            <option value="daybefore">–ü–æ–∑–∞–≤—á–µ—Ä–∞</option>
            <option value="other">–î—Ä—É–≥–æ–µ</option>
          </select>
          <div class="hint">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–∏–æ–¥–æ–≤</div>
        </div>
        <div>
          <label for="limit">üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <select id="limit">
            <option value="10">10 —Å—Ç–∞–Ω—Ü–∏–π</option>
            <option value="20" selected>20 —Å—Ç–∞–Ω—Ü–∏–π</option>
            <option value="50">50 —Å—Ç–∞–Ω—Ü–∏–π</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button id="apply"  class="btn-primary">üîç –ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button id="nearby" class="btn-nearby">üìç –ù–∞–π—Ç–∏ —Ä—è–¥–æ–º</button>
        <button id="send"   class="btn-secondary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
      </div>

      <div class="row" id="geoRow" style="display:none">
        <div class="pill geo-chip" id="lastGeoChip"></div>
      </div>

      <div id="status" class="status">–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É</div>
    </div>

    <div id="list" class="list"></div>
    <div class="footer">
      üí° –í Telegram ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç¬ª –ø–µ—Ä–µ–¥–∞—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –±–æ—Ç—É.
    </div>
  </div>

  <div id="screen-car" class="screen">
    <h1>üöó –ú–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å</h1>
    <div class="card">
      <div class="grid grid-car">
        <div>
          <label for="car_fuel_type">‚õΩ –¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞</label>
          <select id="car_fuel_type">
            <option value="95">95 –±–µ–Ω–∑–∏–Ω</option>
            <option value="98">98 –±–µ–Ω–∑–∏–Ω</option>
            <option value="diesel">–î–∏–∑–µ–ª—å</option>
            <option value="lpg">–ì–∞–∑</option>
          </select>
        </div>
        <div>
          <label for="car_consumption">üìè –†–∞—Å—Ö–æ–¥ (–ª/100–∫–º)</label>
          <input id="car_consumption" type="number" step="0.1" min="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 7.5">
        </div>
        <div>
          <label for="car_tank">üõ¢Ô∏è –û–±—ä—ë–º –±–∞–∫–∞ (–ª)</label>
          <input id="car_tank" type="number" step="1" min="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 50">
        </div>
        <div>
          <label for="car_current">üìä –°–µ–π—á–∞—Å –≤ –±–∞–∫–µ (–ª)</label>
          <input id="car_current" type="number" step="1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 15">
        </div>
        <div>
          <label for="car_time_value">üí∞ –¶–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏ (‚Ç¨/—á–∞—Å)</label>
          <input id="car_time_value" type="number" step="1" min="0" placeholder="0 = –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å">
        </div>
        <div>
          <label for="car_detour">üõ£Ô∏è –ú–∞–∫—Å. –æ–±—ä–µ–∑–¥ (–º–∏–Ω)</label>
          <input id="car_detour" type="number" step="1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 10">
        </div>
      </div>

      <div style="margin-top:24px">
        <label for="car_pref_brands">‚≠ê –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–µ –±—Ä–µ–Ω–¥—ã</label>
        <select id="car_pref_brands" multiple size="6" style="height:140px"></select>
        <div class="hint">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å—Ç–∞–Ω—Ü–∏–π</div>
      </div>

      <div style="margin-top:24px">
        <label>üí≥ –°–∫–∏–¥–∫–∏ –ø–æ –±—Ä–µ–Ω–¥–∞–º (‚Ç¨/–ª)</label>
        <div id="discList" class="discounts"></div>
        <div class="row" style="margin-top:12px">
          <button id="discAdd" class="btn-secondary" style="max-width:240px">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É</button>
          <div class="hint" style="align-self:center;margin-top:0;">–ù–∞–ø—Ä–∏–º–µ—Ä, 0.04 = 4 —Ü–µ–Ω—Ç–∞</div>
        </div>
      </div>

      <div class="row" style="margin-top:24px">
        <button id="carSave" class="btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="carApplyToFilters" class="btn-nearby">üîÑ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º</button>
        <button id="carReset" class="btn-link">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>

      <div id="carStatus" class="status">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª</div>
    </div>
  </div>
</div>

<!-- —Ç–∞–±–±–∞—Ä -->
<div class="tabbar">
  <div id="tabStations" class="tab-btn active"><div class="tab-icon">‚õΩ</div><div>–°—Ç–∞–Ω—Ü–∏–∏</div></div>
  <div id="tabCar" class="tab-btn"><div class="tab-icon">üöó</div><div>–ú–æ–π –∞–≤—Ç–æ</div></div>
</div>

<script>
(() => {
  const API_BASE = "https://et14k9zlk8.execute-api.eu-north-1.amazonaws.com";
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) { try { tg.ready(); tg.expand(); if (tg.colorScheme === 'dark') document.body.classList.add('tg-dark'); } catch{} }

  // –ü—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º-–ª–æ–≥–æ—Ç–∏–ø–∞–º (–ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª—ã –≤ —Ä–µ–ø–æ)
  const ASSETS = {
    maps: "maps.png", // Google_Maps_icon
    waze: "waze.jpg"  // Waze-App-Icon
  };

  async function registerFromWebApp(){
    if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) return;
    const u = tg.initDataUnsafe.user;
    try {
      await fetch(`${API_BASE}/user/register`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          source:'telegram_webapp',
          platform_user_id:String(u.id),
          username:u.username||null,
          first_name:u.first_name||null,
          last_name:u.last_name||null,
          lang: tg.initDataUnsafe?.user?.language_code||null
        })
      });
    } catch(e) {}
  }

  const els = {
    country:$('#country'), city:$('#city'), brand:$('#brand'), fuel:$('#fuel'),
    fresh:$('#fresh'), limit:$('#limit'), apply:$('#apply'), nearby:$('#nearby'),
    send:$('#send'), list:$('#list'), status:$('#status'), lastGeo:$('#lastGeoChip'),
    geoRow:$('#geoRow'),
    carFuel:$('#car_fuel_type'), carCons:$('#car_consumption'), carTank:$('#car_tank'),
    carCurrent:$('#car_current'), carTimeVal:$('#car_time_value'), carDetour:$('#car_detour'),
    carPrefBrands:$('#car_pref_brands'), discList:$('#discList'), discAdd:$('#discAdd'),
    carSave:$('#carSave'), carApplyToFilters:$('#carApplyToFilters'), carReset:$('#carReset'),
    carStatus:$('#carStatus'),
    screenStations:$('#screen-stations'), screenCar:$('#screen-car'),
    tabStations:$('#tabStations'), tabCar:$('#tabCar')
  };
  function $(id){ return document.getElementById(id.replace(/^#/,'')); }

  async function fetchJSON(url){ const r=await fetch(url,{mode:'cors'}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}: ${await r.text().catch(()=>r.status)}`); return r.json(); }
  function setStatus(m,c=''){ els.status.textContent=m; els.status.className='status '+(c||''); }
  function setCarStatus(m,c=''){ els.carStatus.textContent=m; els.carStatus.className='status '+(c||''); }
  function selValues(s){ return Array.from(s.selectedOptions).map(o=>o.value).filter(Boolean); }
  function setOptions(s, opts){ s.innerHTML = opts.map(o=>`<option value="${o}">${o}</option>`).join(''); }
  function preselect(s, vals){ const set=new Set(vals||[]); Array.from(s.options).forEach(o=>o.selected=set.has(o.value)); }
  function setLastGeo(lat,lon){ if(lat==null||lon==null){ els.geoRow.style.display='none'; return;} els.geoRow.style.display='flex'; els.lastGeo.innerHTML=`üìç –ü–æ—Å–ª–µ–¥–Ω—è—è –ª–æ–∫–∞—Ü–∏—è: ${lat.toFixed(4)}, ${lon.toFixed(4)}`; }

  function saveState(){ localStorage.setItem('fuelFinderState', JSON.stringify({
    c:els.country.value, ci:els.city.value, brs:selValues(els.brand), f:els.fuel.value, l:els.limit.value, frs:selValues(els.fresh)
  })); }
  function restoreState(){ try{ const s=JSON.parse(localStorage.getItem('fuelFinderState')||'{}'); if(!s.frs&&s.fr)s.frs=[s.fr]; return s; }catch{return{}}}
  function saveMyCar(mc){ localStorage.setItem('fuelMyCar', JSON.stringify(mc)); }
  function loadMyCar(){ try{ return JSON.parse(localStorage.getItem('fuelMyCar')||'{}'); }catch{return{}} }

  let ALL_BRANDS = [];
  async function loadCountries(){
    setStatus('üîÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶'); els.country.disabled=true; els.country.innerHTML=`<option>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option>`; els.country.classList.add('loading');
    try{
      const j=await fetchJSON(`${API_BASE}/meta`);
      const countries=j.countries||[]; ALL_BRANDS=j.brands||[];
      setOptions(els.country, countries);
      fillBrands(ALL_BRANDS, restoreState().brs||[]);
      setOptions(els.carPrefBrands, ALL_BRANDS);
      preselect(els.carPrefBrands, loadMyCar().preferred_brands||[]);
      const saved=restoreState();
      if(saved.c && countries.includes(saved.c)) els.country.value=saved.c;
      await onCountryChange(saved.ci, saved.brs||[]);
      preselect(els.fresh, saved.frs||[]);
      setStatus('‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É');
    }catch(e){ console.error(e); setStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö','err'); els.country.innerHTML=`<option>–û—à–∏–±–∫–∞</option>`; }
    finally{ els.country.disabled=false; els.country.classList.remove('loading'); }
  }
  function fillBrands(brands, preVals){ els.brand.innerHTML=(brands||[]).map(b=>`<option value="${b}">${b}</option>`).join(''); preselect(els.brand, preVals||[]); }
  async function onCountryChange(prefCity){
    const c=els.country.value; setStatus('üîÑ –ó–∞–≥—Ä—É–∂–∞—é –≥–æ—Ä–æ–¥–∞‚Ä¶'); els.city.disabled=true; els.brand.disabled=true; els.city.classList.add('loading');
    try{
      const j=await fetchJSON(`${API_BASE}/meta?country=${encodeURIComponent(c)}`);
      const cities=j.cities||[];
      els.city.innerHTML=`<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>`+cities.map(ci=>`<option>${ci}</option>`).join('');
      if(prefCity && cities.includes(prefCity)) els.city.value=prefCity;
      setStatus('‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É');
    }catch(e){ console.error(e); setStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤','err'); els.city.innerHTML=`<option>–û—à–∏–±–∫–∞</option>`; }
    finally{ els.city.disabled=false; els.brand.disabled=false; els.city.classList.remove('loading'); }
  }

  function _norm(s){ if(!s) return ''; return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }
  function translateFreshLabel(raw){
    if(!raw) return ''; const n=_norm(raw);
    if(['sodien','siandien','tana','tana.','sodien.','siandien.','≈°odien'].includes(n)) return '–°–µ–≥–æ–¥–Ω—è';
    if(['vakar','eile','vakar.','eile.'].includes(n)) return '–í—á–µ—Ä–∞';
    if(['aizvakar','uzvakar','uleeile','ule eile','ule-eile'].includes(n)) return '–ü–æ–∑–∞–≤—á–µ—Ä–∞';
    if(/\d/.test(raw)) return raw; return raw;
  }
  function classifyFresh(it){
    const raw=(it.fresh_label||'').trim(), n=_norm(raw);
    if(['sodien','siandien','tana','≈°odien'].includes(n)) return 'today';
    if(['vakar','eile'].includes(n)) return 'yesterday';
    if(['aizvakar','uzvakar','uleeile','ule eile','ule-eile'].includes(n)) return 'daybefore';
    if(it.fresh_days===0) return 'today';
    if(it.fresh_days===1) return 'yesterday';
    if(it.fresh_days===2) return 'daybefore';
    return 'other';
  }
  function passesFreshFilter(it, want){ if(!want||!want.length) return true; return want.includes(classifyFresh(it)); }

  async function applyFilters(){
    setStatus('üîç –ò—â—É —Å—Ç–∞–Ω—Ü–∏–∏‚Ä¶'); els.list.innerHTML='';
    const brands=selValues(els.brand), wantFresh=selValues(els.fresh);
    const qs=new URLSearchParams({country:els.country.value||'', city:els.city.value||'', brands:brands.join(','), fuel:els.fuel.value||'95', limit:els.limit.value||50});
    try{
      const j=await fetchJSON(`${API_BASE}/search?`+qs.toString());
      const items=(j.items||[]).filter(it=>passesFreshFilter(it, wantFresh));
      setStatus(`‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${items.length}`);
      renderList(items); saveState();
    }catch(e){ console.error(e); setStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞','err'); els.list.innerHTML=`<div class="item"><span style="color:#ef4444">${String(e).slice(0,200)}</span></div>`; }
  }

  function gmapsDir(it){
    if(it.lat!=null && it.lon!=null){
      return `https://www.google.com/maps/dir/?api=1&destination=${it.lat},${it.lon}&travelmode=driving`;
    }
    const q=encodeURIComponent(`${it.name||''} ${it.address||''} ${it.city||''} ${it.country||''}`.trim());
    return `https://www.google.com/maps/dir/?api=1&destination=${q}&travelmode=driving`;
  }
  function wazeNav(it){
    if(it.lat!=null && it.lon!=null) return `https://waze.com/ul?ll=${it.lat},${it.lon}&navigate=yes`;
    const q=encodeURIComponent(`${it.name||''} ${it.address||''} ${it.city||''} ${it.country||''}`.trim());
    return `https://waze.com/ul?q=${q}&navigate=yes`;
  }

  function renderList(items){
    if(!items.length){ els.list.innerHTML='<div class="item"><div style="color:var(--muted);text-align:center;padding:20px;">üîç –°—Ç–∞–Ω—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div></div>'; return; }
    els.list.innerHTML = items.map((it,i)=>{
      const price = it.price!=null ? Number(it.price).toFixed(3) : '‚Äî';
      const freshTxt = translateFreshLabel(it.fresh_label) || (it.fresh_days!=null ? (it.fresh_days===0?'–°–µ–≥–æ–¥–Ω—è':it.fresh_days===1?'–í—á–µ—Ä–∞':it.fresh_days===2?'–ü–æ–∑–∞–≤—á–µ—Ä–∞':`${it.fresh_days} –¥–Ω. –Ω–∞–∑–∞–¥`) : '');
      const info = [it.brand, it.country, it.city].filter(Boolean).join(' ‚Ä¢ ') + (freshTxt?` ‚Ä¢ üìÖ ${freshTxt}`:'');
      return `<div class="item">
        <div class="item-title">${i+1}. ${it.name}</div>
        <div class="item-price">${price} ‚Ç¨/–ª</div>
        <div class="item-info">${info}</div>
        <div class="item-info">üìç ${it.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
        <div class="links">
          <a class="icon-btn maps" href="${gmapsDir(it)}" target="_blank" rel="noopener" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ Google Maps" title="–û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ Google Maps">
            <img src="${ASSETS.maps}" alt="Google Maps">
          </a>
          <a class="icon-btn waze" href="${wazeNav(it)}" target="_blank" rel="noopener" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ Waze" title="–û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ Waze">
            <img src="${ASSETS.waze}" alt="Waze">
          </a>
        </div>
      </div>`;
    }).join('');
  }

  async function findNearby(){
    if(!navigator.geolocation){ setStatus('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è','err'); return; }
    const brands=selValues(els.brand), wantFresh=selValues(els.fresh);
    setStatus('üìç –ü–æ–ª—É—á–∞—é –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Ä¶');
    navigator.geolocation.getCurrentPosition(async pos=>{
      const {latitude,longitude}=pos.coords; setStatus('üîç –ò—â—É –±–ª–∏–∂–∞–π—à–∏–µ‚Ä¶');
      const qs=new URLSearchParams({lat:latitude, lon:longitude, brands:brands.join(','), fuel:els.fuel.value||'95', limit:els.limit.value||50, routing:'drive'});
      try{
        const j=await fetchJSON(`${API_BASE}/nearby?`+qs.toString());
        const items=(j.items||[]).filter(it=>passesFreshFilter(it, wantFresh));
        setStatus(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä—è–¥–æ–º: ${items.length}`);
        renderListWithDistance(items);
        localStorage.setItem('fuelFinderLastGeo', JSON.stringify({lat:latitude, lon:longitude}));
        setLastGeo(latitude, longitude);
      }catch(e){ console.error(e); setStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ä—è–¥–æ–º','err'); }
    }, err=> setStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é: '+err.message,'err'), {enableHighAccuracy:true, timeout:10000, maximumAge:60000});
  }

  function renderListWithDistance(items){
    if(!items.length){ els.list.innerHTML='<div class="item"><div style="color:var(--muted);text-align:center;padding:20px;">üìç –†—è–¥–æ–º —Å—Ç–∞–Ω—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>'; return; }
    els.list.innerHTML = items.map((it,i)=>{
      const price = it.price!=null ? Number(it.price).toFixed(3) : '‚Äî';
      const freshTxt = translateFreshLabel(it.fresh_label) || (it.fresh_days!=null ? (it.fresh_days===0?'–°–µ–≥–æ–¥–Ω—è':it.fresh_days===1?'–í—á–µ—Ä–∞':it.fresh_days===2?'–ü–æ–∑–∞–≤—á–µ—Ä–∞':`${it.fresh_days} –¥–Ω. –Ω–∞–∑–∞–¥`) : '');
      const straight = (it.distance_km!=null)?` ‚Ä¢ üìè ${Number(it.distance_km).toFixed(1)} –∫–º`:'';
      const road = (it.drive_distance_km!=null||it.drive_duration_min!=null)
        ? ` ‚Ä¢ üõ£Ô∏è ${it.drive_distance_km!=null?Number(it.drive_distance_km).toFixed(1)+' –∫–º':'‚Äî'}${it.drive_duration_min!=null?', '+Number(it.drive_duration_min).toFixed(0)+' –º–∏–Ω':''}`:'';
      const head = [it.brand, it.country, it.city].filter(Boolean).join(' ‚Ä¢ ') + (freshTxt?` ‚Ä¢ üìÖ ${freshTxt}`:'') + straight + road;

      return `<div class="item">
        <div class="item-title">${i+1}. ${it.name}</div>
        <div class="item-price">${price} ‚Ç¨/–ª</div>
        <div class="item-info">${head}</div>
        <div class="item-info">üìç ${it.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
        <div class="links">
          <a class="icon-btn maps" href="${gmapsDir(it)}" target="_blank" rel="noopener" aria-label="–ú–∞—Ä—à—Ä—É—Ç –≤ Google Maps" title="–ú–∞—Ä—à—Ä—É—Ç –≤ Google Maps">
            <img src="${ASSETS.maps}" alt="Google Maps">
          </a>
          <a class="icon-btn waze" href="${wazeNav(it)}" target="_blank" rel="noopener" aria-label="–ú–∞—Ä—à—Ä—É—Ç –≤ Waze" title="–ú–∞—Ä—à—Ä—É—Ç –≤ Waze">
            <img src="${ASSETS.waze}" alt="Waze">
          </a>
        </div>
      </div>`;
    }).join('');
  }

  function sendToBot(){
    if(!tg || !tg.sendData){ setStatus('‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏','err'); return; }
    const payload={ country:els.country.value||'', city:els.city.value||'', brands:selValues(els.brand),
                    fuel:(els.fuel.value||'95').toLowerCase(), fresh:selValues(els.fresh) };
    try{ tg.sendData(JSON.stringify(payload)); setStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç!','ok'); }catch(e){ setStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å','err'); }
  }

  // —Å–∫–∏–¥–∫–∏/–ø—Ä–æ—Ñ–∏–ª—å
  function makeDiscRow(brand='',off=''){
    const row=document.createElement('div'); row.className='disc-row';
    const sel=document.createElement('select'); sel.innerHTML=(ALL_BRANDS||[]).map(b=>`<option>${b}</option>`).join(''); if(brand) sel.value=brand;
    const inp=document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.min='0'; inp.placeholder='0.04'; if(off!==''&&off!=null) inp.value=off;
    const del=document.createElement('button'); del.className='btn-secondary'; del.innerHTML='üóëÔ∏è'; del.title='–£–¥–∞–ª–∏—Ç—å —Å–∫–∏–¥–∫—É'; del.onclick=()=>row.remove();
    row.append(sel,inp,del); return row;
  }
  function loadDiscounts(el,discs){ el.innerHTML=''; (discs||[]).forEach(d=>el.appendChild(makeDiscRow(d.brand,d.off_eur_per_l))); if(!discs||!discs.length) el.appendChild(makeDiscRow()); }
  function collectDiscounts(el){ const out=[]; el.querySelectorAll('.disc-row').forEach(r=>{ const b=r.querySelector('select')?.value||''; const off=parseFloat(r.querySelector('input')?.value); if(b&&!isNaN(off)&&off>0) out.push({brand:b,off_eur_per_l:+off}); }); return out; }
  function readMyCarFromUI(){ return {
    fuel_type:els.carFuel.value||'95', consumption_l_per_100:+els.carCons.value||null, tank_capacity_l:+els.carTank.value||null,
    current_level_l:+els.carCurrent.value||null, time_value_eur_per_hour:+els.carTimeVal.value||0, max_detour_min:+els.carDetour.value||0,
    preferred_brands:selValues(els.carPrefBrands), discounts:collectDiscounts(els.discList)
  }; }
  function writeMyCarToUI(mc){ if(!mc) return;
    if(mc.fuel_type) els.carFuel.value=mc.fuel_type;
    if(mc.consumption_l_per_100!=null) els.carCons.value=mc.consumption_l_per_100;
    if(mc.tank_capacity_l!=null) els.carTank.value=mc.tank_capacity_l;
    if(mc.current_level_l!=null) els.carCurrent.value=mc.current_level_l;
    if(mc.time_value_eur_per_hour!=null) els.carTimeVal.value=mc.time_value_eur_per_hour;
    if(mc.max_detour_min!=null) els.carDetour.value=mc.max_detour_min;
    preselect(els.carPrefBrands, mc.preferred_brands||[]); loadDiscounts(els.discList, mc.discounts||[]);
  }
  function applyMyCarToFilters(mc){ if(!mc) mc=loadMyCar(); if(mc.fuel_type) els.fuel.value=mc.fuel_type;
    if(mc.preferred_brands && mc.preferred_brands.length){ preselect(els.brand, mc.preferred_brands.filter(b=>(ALL_BRANDS||[]).includes(b))); } saveState(); }

  function switchTab(name){ const isStations=(name==='stations'); els.screenStations.classList.toggle('active',isStations);
    els.screenCar.classList.toggle('active',!isStations); els.tabStations.classList.toggle('active',isStations); els.tabCar.classList.toggle('active',!isStations); }

  els.country.addEventListener('change', ()=> onCountryChange('', []));
  els.apply.addEventListener('click', applyFilters);
  els.nearby.addEventListener('click', findNearby);
  els.send.addEventListener('click', sendToBot);
  els.discAdd.addEventListener('click', ()=> els.discList.appendChild(makeDiscRow()));
  els.carSave.addEventListener('click', ()=>{ const mc=readMyCarFromUI(); saveMyCar(mc); setCarStatus('üíæ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!','ok'); });
  els.carApplyToFilters.addEventListener('click', ()=>{ applyMyCarToFilters(); setCarStatus('üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º!','ok'); switchTab('stations'); applyFilters(); });
  els.carReset.addEventListener('click', ()=>{ if(confirm('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è?')){ localStorage.removeItem('fuelMyCar'); writeMyCarToUI({}); setCarStatus('üóëÔ∏è –ü—Ä–æ—Ñ–∏–ª—å –æ—á–∏—â–µ–Ω','ok'); }});
  els.tabStations.addEventListener('click', ()=> switchTab('stations'));
  els.tabCar.addEventListener('click', ()=> switchTab('car'));

  const saved=restoreState(); if(saved.f) els.fuel.value=saved.f; if(saved.l) els.limit.value=saved.l;
  const mcSaved=loadMyCar(); writeMyCarToUI(mcSaved); if(mcSaved.fuel_type) els.fuel.value=mcSaved.fuel_type;
  try{ const g=JSON.parse(localStorage.getItem('fuelFinderLastGeo')||'{}'); if(g.lat!=null && g.lon!=null) setLastGeo(g.lat,g.lon); }catch{}
  if(tg){ registerFromWebApp(); }
  loadCountries().then(()=>{ setOptions(els.carPrefBrands, ALL_BRANDS); preselect(els.carPrefBrands, mcSaved.preferred_brands||[]);
    loadDiscounts(els.discList, mcSaved.discounts||[]); if(mcSaved.preferred_brands&&mcSaved.preferred_brands.length){ preselect(els.brand, mcSaved.preferred_brands.filter(b=>(ALL_BRANDS||[]).includes(b))); }
    else if(saved.brs){ preselect(els.brand, saved.brs); } preselect(els.fresh, saved.frs||[]); applyFilters(); });
})();
</script>
</body>
</html>
