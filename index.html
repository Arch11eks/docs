<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fuel Finder ‚Äî –ê–ó–° –∏ My Car</title>
  <style>
    :root{ --bg:#0f0f10; --card:#15161a; --border:#26282d; --muted:#9aa0a6; --text:#e9eaee;
           --btn:#1a73e8; --btn-text:#fff; --item:#121317; --ok:#22c55e; --err:#ef4444; --accent:#4da3ff; --nearby:#10b981; --tab:#0e1014;
           --iconbg:#0f151d; --maps:#1a73e8; --waze:#26c4f1 }
    body.tg-dark{ --bg:#0b0e11; --card:#111418; --border:#1e2228; --muted:#8f98a3; --text:#e6e9ef; --item:#0f1318; --btn:#5e9bff; --nearby:#16a34a; --tab:#0b0d12;
                  --iconbg:#0c1117 }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Arial}
    a{color:var(--accent);text-decoration:none}
    h1{font-size:22px;margin:0 0 12px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    select,button,input{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:#101114;color:var(--text)}
    select:disabled,input:disabled{opacity:.6}
    small.hint{display:block;color:var(--muted);margin-top:4px}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px 80px} /* —Å–Ω–∏–∑—É –∑–∞–ø–∞—Å –ø–æ–¥ —Ç–∞–±–±–∞—Ä */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .grid{display:grid;gap:10px}
    .row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    .btn{background:var(--btn);color:var(--btn-text);font-weight:600;border:0;cursor:pointer;transition:filter .15s}
    .btn.secondary{background:#20242c;color:var(--text);border:1px solid var(--border)}
    .btn.nearby{background:var(--nearby)}
    .btn.linklike{background:transparent;border:0;color:var(--accent);padding:0}
    .btn:hover{filter:brightness(1.05)}
    .status{margin-top:8px;color:var(--muted);min-height:18px}
    .list{margin-top:14px;display:grid;gap:10px}
    .item{background:var(--item);border:1px solid var(--border);border-radius:12px;padding:12px}
    .muted{color:var(--muted)} .price{font-weight:700}
    .footer{margin:18px 0 120px;color:var(--muted);font-size:12px;text-align:center}

    /* –±–ª–æ–∫ —Å—Å—ã–ª–æ–∫-–∫–Ω–æ–ø–æ–∫ —Å –∏–∫–æ–Ω–∫–∞–º–∏ */
    .links{display:flex;gap:10px;align-items:center;margin-top:6px}
    .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:var(--iconbg);border:1px solid var(--border)}
    .iconbtn:hover{filter:brightness(1.08)}
    .iconbtn svg{width:22px;height:22px;display:block}
    .iconbtn.maps svg{color:var(--maps)}
    .iconbtn.waze svg{color:var(--waze)}

    /* —Ç–∞–±–±–∞—Ä —Å–Ω–∏–∑—É */
    .tabbar{position:fixed;left:0;right:0;bottom:0;background:var(--tab);border-top:1px solid var(--border);display:flex}
    .tabbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;color:var(--muted);cursor:pointer;user-select:none}
    .tabbtn.active{color:var(--text);font-weight:600}
    .tabbtn .ico{font-size:18px}
    .screen{display:none} .screen.active{display:block}

    /* –≥—Ä–∏–¥—ã */
    .grid.stations{grid-template-columns:repeat(5,1fr) 120px}
    @media (max-width:1100px){.grid.stations{grid-template-columns:1fr 1fr 1fr 1fr 1fr}}
    @media (max-width:900px){.grid.stations{grid-template-columns:1fr 1fr 1fr}}
    @media (max-width:600px){.grid.stations{grid-template-columns:1fr 1fr}}

    .grid.car{grid-template-columns:1fr 1fr}
    @media (max-width:800px){.grid.car{grid-template-columns:1fr}}

    .discounts{display:grid;gap:8px}
    .disc-row{display:grid;grid-template-columns:1fr 140px 40px;gap:8px}
    .disc-row button{width:40px;padding:0}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0f151d;color:var(--muted);font-size:12px}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">
  <div id="screen-stations" class="screen active">
    <h1>‚õΩ –°—Ç–∞–Ω—Ü–∏–∏</h1>
    <div class="card">
      <div class="grid stations">
        <div><label for="country">–°—Ç—Ä–∞–Ω–∞</label><select id="country"></select></div>
        <div><label for="city">–ì–æ—Ä–æ–¥</label><select id="city"><option value="">–í—Å–µ</option></select></div>
        <div>
          <label for="brand">–ë—Ä–µ–Ω–¥—ã</label>
          <select id="brand" multiple size="4"></select>
          <small class="hint">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ</small>
        </div>
        <div>
          <label for="fuel">–¢–æ–ø–ª–∏–≤–æ</label>
          <select id="fuel"><option>95</option><option>98</option><option>diesel</option><option>lpg</option></select>
        </div>
        <div>
          <label for="fresh">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</label>
          <select id="fresh" multiple size="4">
            <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="yesterday">–í—á–µ—Ä–∞</option>
            <option value="daybefore">–ü–æ–∑–∞–≤—á–µ—Ä–∞</option>
            <option value="other">–î—Ä—É–≥–æ–µ</option>
          </select>
          <small class="hint">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ</small>
        </div>
        <div><label for="limit">–õ–∏–º–∏—Ç</label><select id="limit"><option>10</option><option selected>20</option><option>50</option></select></div>
      </div>

      <div class="row">
        <button id="apply" class="btn">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        <button id="nearby" class="btn nearby">üìç –ù–∞–π—Ç–∏ —Ä—è–¥–æ–º</button>
        <button id="send" class="btn secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
      </div>

      <div class="row" id="geoRow" style="display:none">
        <div class="pill" id="lastGeoChip"></div>
      </div>

      <div id="status" class="status">–ì–æ—Ç–æ–≤–æ</div>
    </div>

    <div id="list" class="list"></div>
    <div class="footer">–î–∞–Ω–Ω—ã–µ —Å —Å–∞–π—Ç–∞. –í Telegram –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç¬ª –ø–µ—Ä–µ–¥–∞—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –±–æ—Ç—É.</div>
  </div>

  <div id="screen-car" class="screen">
    <h1>üöò My Car</h1>
    <div class="card">
      <div class="grid car">
        <div>
          <label for="car_fuel_type">–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞</label>
          <select id="car_fuel_type">
            <option>95</option><option>98</option><option>diesel</option><option>lpg</option>
          </select>
        </div>
        <div>
          <label for="car_consumption">–†–∞—Å—Ö–æ–¥ (–ª/100 –∫–º)</label>
          <input id="car_consumption" type="number" step="0.1" min="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 7.5">
        </div>
        <div>
          <label for="car_tank">–û–±—ä—ë–º –±–∞–∫–∞ (–ª)</label>
          <input id="car_tank" type="number" step="1" min="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 50">
        </div>
        <div>
          <label for="car_current">–°–µ–π—á–∞—Å –≤ –±–∞–∫–µ (–ª)</label>
          <input id="car_current" type="number" step="1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 15">
          <small class="hint">–ù—É–∂–Ω–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –¥–æ—Å—Ç–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∑–¥–∞</small>
        </div>
        <div>
          <label for="car_time_value">–¶–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏ (‚Ç¨/—á–∞—Å)</label>
          <input id="car_time_value" type="number" step="1" min="0" placeholder="0 = –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å">
        </div>
        <div>
          <label for="car_detour">–ú–∞–∫—Å. –æ–±—ä–µ–∑–¥ (–º–∏–Ω)</label>
          <input id="car_detour" type="number" step="1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 10">
        </div>
      </div>

      <div style="margin-top:14px">
        <label for="car_pref_brands">–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã</label>
        <select id="car_pref_brands" multiple size="6" style="height:140px"></select>
        <small class="hint">–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ ¬´–ë—Ä–µ–Ω–¥—ã¬ª</small>
      </div>

      <div style="margin-top:14px">
        <label>–°–∫–∏–¥–∫–∏ –ø–æ –±—Ä–µ–Ω–¥–∞–º (‚Ç¨/–ª)</label>
        <div id="discList" class="discounts"></div>
        <div class="row" style="margin-top:8px">
          <button id="discAdd" class="btn secondary" style="max-width:220px">+ –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É</button>
          <div class="muted" style="align-self:center">–°–∫–∏–¥–∫–∞ –≤ –µ–≤—Ä–æ –∑–∞ –ª–∏—Ç—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.04 = 4 —Ü–µ–Ω—Ç–∞)</div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <button id="carSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="carApplyToFilters" class="btn secondary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º</button>
        <button id="carReset" class="btn linklike">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>

      <div id="carStatus" class="status">–ó–∞–ø–æ–ª–Ω–∏ –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª</div>
    </div>
  </div>
</div>

<!-- —Ç–∞–±–±–∞—Ä -->
<div class="tabbar">
  <div id="tabStations" class="tabbtn active"><div class="ico">‚õΩ</div><div>–°—Ç–∞–Ω—Ü–∏–∏</div></div>
  <div id="tabCar" class="tabbtn"><div class="ico">üöò</div><div>My Car</div></div>
</div>

<script>
(() => {
  const API_BASE = "https://et14k9zlk8.execute-api.eu-north-1.amazonaws.com"; // –¥–æ–±–∞–≤—å /prod –µ—Å–ª–∏ –Ω—É–∂–µ–Ω stage
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) { try { tg.ready(); tg.expand(); if (tg.colorScheme === 'dark') document.body.classList.add('tg-dark'); } catch {} }

  // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ SVG-–∏–∫–æ–Ω–∫–∏ (—Å—Ç—Ä–æ–∫–∏)
  const ICONS = {
    maps: `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M12 22s7-7.2 7-12a7 7 0 1 0-14 0c0 4.8 7 12 7 12z" stroke-width="1.5"></path>
        <circle cx="12" cy="10" r="3.2" stroke-width="1.5"></circle>
      </svg>`,
    waze: `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M7 16.5c-2.8 0-4-1.8-4-4.2C3 8.5 6 5 11 5c4.8 0 8 2.8 8 6.8 0 1.4-.4 2.6-1.2 3.6l1.2 2.1c.3.6-.3 1.3-.9 1.1l-2.4-.8c-.9.6-2 .9-3.2.9H7z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        <circle cx="10" cy="11" r="1.2" stroke-width="1.5"></circle>
        <circle cx="14" cy="11" r="1.2" stroke-width="1.5"></circle>
        <path d="M8.5 16.5c.4.9 1.3 1.5 2.5 1.5s2.1-.6 2.5-1.5" stroke-width="1.5" stroke-linecap="round"></path>
      </svg>`
  };

  // ===== —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ —Ä–∞–Ω—å—à–µ) =====
  async function registerFromWebApp(){
    if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) return;
    const u = tg.initDataUnsafe.user;
    try {
      await fetch(`${API_BASE}/user/register`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          source:'telegram_webapp',
          platform_user_id:String(u.id),
          username:u.username||null,
          first_name:u.first_name||null,
          last_name:u.last_name||null,
          lang: tg.initDataUnsafe?.user?.language_code||null
        })
      });
    } catch(e) {}
  }

  // ===== —ç–ª–µ–º–µ–Ω—Ç—ã =====
  const els = {
    // stations
    country:$('#country'), city:$('#city'), brand:$('#brand'), fuel:$('#fuel'),
    fresh:$('#fresh'), limit:$('#limit'), apply:$('#apply'), nearby:$('#nearby'),
    send:$('#send'), list:$('#list'), status:$('#status'), lastGeo:$('#lastGeoChip'),
    geoRow:$('#geoRow'),
    // car
    carFuel:$('#car_fuel_type'), carCons:$('#car_consumption'), carTank:$('#car_tank'),
    carCurrent:$('#car_current'), carTimeVal:$('#car_time_value'), carDetour:$('#car_detour'),
    carPrefBrands:$('#car_pref_brands'), discList:$('#discList'), discAdd:$('#discAdd'),
    carSave:$('#carSave'), carApplyToFilters:$('#carApplyToFilters'), carReset:$('#carReset'),
    carStatus:$('#carStatus'),
    // tabs
    screenStations:$('#screen-stations'), screenCar:$('#screen-car'),
    tabStations:$('#tabStations'), tabCar:$('#tabCar'),
  };

  function $(id){ return document.getElementById(id.replace(/^#/,'')); }

  // ===== utils =====
  async function fetchJSON(url){ const r=await fetch(url,{mode:'cors'}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}: ${await r.text().catch(()=>r.status)}`); return r.json(); }
  function setStatus(m,c=''){ els.status.textContent=m; els.status.className='status '+(c||''); }
  function setCarStatus(m,c=''){ els.carStatus.textContent=m; els.carStatus.className='status '+(c||''); }
  function selValues(selectEl){ return Array.from(selectEl.selectedOptions).map(o=>o.value).filter(Boolean); }
  function setOptions(selectEl, options){
    selectEl.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join('');
  }
  function preselect(selectEl, values){ const set=new Set(values||[]); Array.from(selectEl.options).forEach(o=>o.selected=set.has(o.value)); }
  function setLastGeo(lat,lon){ if(lat==null||lon==null){ els.geoRow.style.display='none'; return;} els.geoRow.style.display='flex'; els.lastGeo.textContent=`–ü–æ—Å–ª–µ–¥–Ω—è—è –ª–æ–∫–∞—Ü–∏—è: ${lat.toFixed(4)}, ${lon.toFixed(4)}`; }

  // ===== —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π =====
  function saveState(){
    localStorage.setItem('fuelFinderState', JSON.stringify({
      c: els.country.value, ci: els.city.value, brs: selValues(els.brand),
      f: els.fuel.value, l: els.limit.value, frs: selValues(els.fresh)
    }));
  }
  function restoreState(){
    try{ const s = JSON.parse(localStorage.getItem('fuelFinderState') || '{}'); if(!s.frs && s.fr) s.frs=[s.fr]; return s; }catch{ return {}; }
  }
  function saveMyCar(mc){ localStorage.setItem('fuelMyCar', JSON.stringify(mc)); }
  function loadMyCar(){ try{ return JSON.parse(localStorage.getItem('fuelMyCar')||'{}'); }catch{return {};} }

  // ===== meta =====
  let ALL_BRANDS = [];
  async function loadCountries(){
    setStatus('–ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–∞–Ω—ã‚Ä¶'); els.country.disabled=true; els.country.innerHTML=`<option>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option>`;
    try{
      const j = await fetchJSON(`${API_BASE}/meta`);
      const countries = j.countries || [];
      ALL_BRANDS = j.brands || [];
      setOptions(els.country, countries);
      fillBrands(ALL_BRANDS, restoreState().brs||[]);
      setOptions(els.carPrefBrands, ALL_BRANDS);
      preselect(els.carPrefBrands, loadMyCar().preferred_brands || []);

      const saved = restoreState();
      if (saved.c && countries.includes(saved.c)) els.country.value = saved.c;
      await onCountryChange(saved.ci, saved.brs || []);
      preselect(els.fresh, saved.frs || []);
      setStatus('–ì–æ—Ç–æ–≤–æ');
    }catch(e){ console.error(e); setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω','err'); els.country.innerHTML=`<option>–û—à–∏–±–∫–∞</option>`; }
    finally{ els.country.disabled=false; }
  }
  function fillBrands(brands, preselectVals){
    els.brand.innerHTML = (brands||[]).map(b => `<option value="${b}">${b}</option>`).join('');
    preselect(els.brand, preselectVals||[]);
  }

  async function onCountryChange(prefCity, prefBrands){
    const c = els.country.value; setStatus('–ó–∞–≥—Ä—É–∂–∞—é –≥–æ—Ä–æ–¥–∞/–±—Ä–µ–Ω–¥—ã‚Ä¶'); els.city.disabled=true; els.brand.disabled=true;
    try{
      const j = await fetchJSON(`${API_BASE}/meta?country=${encodeURIComponent(c)}`);
      const cities = j.cities || [];
      els.city.innerHTML = `<option value="">–í—Å–µ</option>` + cities.map(ci=>`<option>${ci}</option>`).join('');
      if (prefCity && cities.includes(prefCity)) els.city.value = prefCity;
      setStatus('–ì–æ—Ç–æ–≤–æ');
    }catch(e){ console.error(e); setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤','err'); els.city.innerHTML=`<option>–û—à–∏–±–∫–∞</option>`; }
    finally{ els.city.disabled=false; els.brand.disabled=false; }
  }

  // ===== –ø–µ—Ä–µ–≤–æ–¥ —Å–≤–µ–∂–µ—Å—Ç–∏ =====
  function _norm(s){ if(!s) return ''; return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }
  function translateFreshLabel(raw){
    if (!raw) return '';
    const n=_norm(raw);
    if (['sodien','siandien','tana','tana.','sodien.','siandien.','≈°odien'].includes(n)) return '–°–µ–≥–æ–¥–Ω—è';
    if (['vakar','eile','vakar.','eile.'].includes(n)) return '–í—á–µ—Ä–∞';
    if (['aizvakar','uzvakar','uleeile','ule eile','ule-eile'].includes(n)) return '–ü–æ–∑–∞–≤—á–µ—Ä–∞';
    if (/\d/.test(raw)) return raw;
    return raw;
  }
  function classifyFresh(it){
    const raw=(it.fresh_label||'').trim(), n=_norm(raw);
    if (['sodien','siandien','tana','≈°odien'].includes(n)) return 'today';
    if (['vakar','eile'].includes(n)) return 'yesterday';
    if (['aizvakar','uzvakar','uleeile','ule eile','ule-eile'].includes(n)) return 'daybefore';
    if (it.fresh_days===0) return 'today';
    if (it.fresh_days===1) return 'yesterday';
    if (it.fresh_days===2) return 'daybefore';
    return 'other';
  }
  function passesFreshFilter(it, wantArr){
    if (!wantArr || wantArr.length===0) return true;
    return wantArr.includes(classifyFresh(it));
  }

  // ===== Stations: –ø–æ–∏—Å–∫ =====
  async function applyFilters(){
    setStatus('–ò—â—É‚Ä¶'); els.list.innerHTML='';
    const brands = selValues(els.brand);
    const wantFresh = selValues(els.fresh);
    const qs = new URLSearchParams({
      country: els.country.value || '', city: els.city.value || '',
      brands: brands.join(','), fuel: els.fuel.value || '95',
      limit: els.limit.value || 50,
    });
    try{
      const j = await fetchJSON(`${API_BASE}/search?`+qs.toString());
      const items = (j.items||[]).filter(it => passesFreshFilter(it, wantFresh));
      setStatus(`–ù–∞–π–¥–µ–Ω–æ: ${items.length}`);
      renderList(items);
      saveState();
    }catch(e){
      console.error(e);
      setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤','err');
      els.list.innerHTML = `<div class="item"><span class="muted">${String(e).slice(0,240)}</span></div>`;
    }
  }

  function renderList(items){
    if(!items.length){ els.list.innerHTML='<div class="item"><span class="muted">–ü—É—Å—Ç–æ</span></div>'; return;}
    els.list.innerHTML = items.map((it,i)=>{
      const price = it.price!=null ? Number(it.price).toFixed(3) : '‚Äî';
      const freshTxt = translateFreshLabel(it.fresh_label) || (it.fresh_days!=null ? (it.fresh_days===0?'–°–µ–≥–æ–¥–Ω—è':it.fresh_days===1?'–í—á–µ—Ä–∞':it.fresh_days===2?'–ü–æ–∑–∞–≤—á–µ—Ä–∞':`${it.fresh_days} –¥ –Ω–∞–∑–∞–¥`) : '');
      const updated = freshTxt ? ` ¬∑ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${freshTxt}` : '';
      const info = [it.brand, it.country, it.city].filter(Boolean).join(' ¬∑ ') + updated;

      const q = encodeURIComponent(`${it.name} ${it.address||''} ${it.city||''} ${it.country||''}`);
      const gmaps = `https://maps.google.com/?q=${q}`;
      const waze  = (it.lat!=null && it.lon!=null)
        ? `https://waze.com/ul?ll=${it.lat},${it.lon}&navigate=yes`
        : `https://waze.com/ul?q=${q}&navigate=yes`;

      return `<div class="item">
        <div><b>${i+1}. ${it.name}</b> ‚Äî <span class="price">${price} ‚Ç¨/–ª</span></div>
        <div class="muted">${info}</div>
        <div class="muted">${it.address || ''}</div>
        <div class="links">
          <a class="iconbtn maps" href="${gmaps}" target="_blank" rel="noopener" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps">
            ${ICONS.maps}
          </a>
          <a class="iconbtn waze" href="${waze}" target="_blank" rel="noopener" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ Waze" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Waze">
            ${ICONS.waze}
          </a>
        </div>
      </div>`;
    }).join('');
  }

  async function findNearby(){
    if(!navigator.geolocation){ setStatus('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'err'); return; }
    const brands = selValues(els.brand);
    const wantFresh = selValues(els.fresh);
    setStatus('–ü–æ–ª—É—á–∞—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é‚Ä¶');
    navigator.geolocation.getCurrentPosition(async pos=>{
      const {latitude,longitude}=pos.coords; setStatus('–ò—â—É –±–ª–∏–∂–∞–π—à–∏–µ‚Ä¶');
      const qs = new URLSearchParams({
        lat: latitude, lon: longitude,
        brands: brands.join(','), fuel: els.fuel.value || '95',
        limit: els.limit.value || 50, routing: 'drive'
      });
      try{
        const j = await fetchJSON(`${API_BASE}/nearby?`+qs.toString());
        const items = (j.items||[]).filter(it => passesFreshFilter(it, wantFresh));
        setStatus(`–ù–∞–π–¥–µ–Ω–æ —Ä—è–¥–æ–º: ${items.length}`);
        renderListWithDistance(items);
        localStorage.setItem('fuelFinderLastGeo', JSON.stringify({lat:latitude, lon:longitude}));
        setLastGeo(latitude, longitude);
      }catch(e){ console.error(e); setStatus('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ä—è–¥–æ–º','err'); }
    }, err=> setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é: '+err.message, 'err'),
       { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
  }

  function renderListWithDistance(items){
    if(!items.length){ els.list.innerHTML='<div class="item"><span class="muted">–ü—É—Å—Ç–æ</span></div>'; return;}
    els.list.innerHTML = items.map((it,i)=>{
      const price = it.price!=null ? Number(it.price).toFixed(3) : '‚Äî';
      const freshTxt = translateFreshLabel(it.fresh_label) || (it.fresh_days!=null ? (it.fresh_days===0?'–°–µ–≥–æ–¥–Ω—è':it.fresh_days===1?'–í—á–µ—Ä–∞':it.fresh_days===2?'–ü–æ–∑–∞–≤—á–µ—Ä–∞':`${it.fresh_days} –¥ –Ω–∞–∑–∞–¥`) : '');
      const upd = freshTxt ? ` ¬∑ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${freshTxt}` : '';

      const straight = (it.distance_km!=null) ? ` ¬∑ –ø–æ –ø—Ä—è–º–æ–π: ${Number(it.distance_km).toFixed(1)} –∫–º` : '';
      const road = (it.drive_distance_km!=null || it.drive_duration_min!=null)
        ? ` ¬∑ –ø–æ –¥–æ—Ä–æ–≥–µ: ${it.drive_distance_km!=null?Number(it.drive_distance_km).toFixed(1)+' –∫–º':'‚Äî'}${it.drive_duration_min!=null?', '+Number(it.drive_duration_min).toFixed(0)+' –º–∏–Ω':''}`
        : '';
      const head = [it.brand, it.country, it.city].filter(Boolean).join(' ¬∑ ') + upd + straight + road;

      const q = encodeURIComponent(`${it.name} ${it.address||''} ${it.city||''} ${it.country||''}`);
      const gmaps = `https://maps.google.com/?q=${q}`;
      const waze  = `https://waze.com/ul?ll=${it.lat},${it.lon}&navigate=yes`;

      return `<div class="item">
        <div><b>${i+1}. ${it.name}</b> ‚Äî <span class="price">${price} ‚Ç¨/–ª</span></div>
        <div class="muted">${head}</div>
        <div class="muted">${it.address || ''}</div>
        <div class="links">
          <a class="iconbtn maps" href="${gmaps}" target="_blank" rel="noopener" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps">
            ${ICONS.maps}
          </a>
          <a class="iconbtn waze" href="${waze}" target="_blank" rel="noopener" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ Waze" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Waze">
            ${ICONS.waze}
          </a>
        </div>
      </div>`;
    }).join('');
  }

  function sendToBot(){
    if(!tg || !tg.sendData){ setStatus('–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç','err'); return; }
    const payload = {
      country: els.country.value || '', city: els.city.value || '',
      brands: selValues(els.brand), fuel: (els.fuel.value || '95').toLowerCase(),
      fresh: selValues(els.fresh) // –º–∞—Å—Å–∏–≤: today/yesterday/daybefore/other
    };
    try{ tg.sendData(JSON.stringify(payload)); setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ‚úî','ok'); }
    catch(e){ setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å','err'); }
  }

  // ===== My Car: —Å–∫–∏–¥–∫–∏ UI =====
  function makeDiscRow(brand='', off=''){
    const row = document.createElement('div');
    row.className = 'disc-row';
    const sel = document.createElement('select'); sel.innerHTML = (ALL_BRANDS||[]).map(b=>`<option>${b}</option>`).join('');
    if (brand) sel.value = brand;
    const inp = document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.min='0'; inp.placeholder='0.04';
    if (off!=='' && off!=null) inp.value = off;
    const del = document.createElement('button'); del.className='btn secondary'; del.textContent='‚úï'; del.title='–£–¥–∞–ª–∏—Ç—å';
    del.onclick = () => row.remove();
    row.appendChild(sel); row.appendChild(inp); row.appendChild(del);
    return row;
  }
  function loadDiscounts(listEl, discounts){
    listEl.innerHTML='';
    (discounts||[]).forEach(d => listEl.appendChild(makeDiscRow(d.brand, d.off_eur_per_l)));
    if (!discounts || discounts.length===0) listEl.appendChild(makeDiscRow());
  }
  function collectDiscounts(listEl){
    const out=[]; listEl.querySelectorAll('.disc-row').forEach(r=>{
      const brand = r.querySelector('select')?.value || '';
      const off = parseFloat(r.querySelector('input')?.value);
      if (brand && !isNaN(off) && off>0) out.push({brand, off_eur_per_l: +off});
    });
    return out;
  }

  // ===== My Car: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ =====
  function readMyCarFromUI(){
    return {
      fuel_type: els.carFuel.value || '95',
      consumption_l_per_100: +els.carCons.value || null,
      tank_capacity_l: +els.carTank.value || null,
      current_level_l: +els.carCurrent.value || null,
      time_value_eur_per_hour: +els.carTimeVal.value || 0,
      max_detour_min: +els.carDetour.value || 0,
      preferred_brands: selValues(els.carPrefBrands),
      discounts: collectDiscounts(els.discList)
    };
  }
  function writeMyCarToUI(mc){
    if (!mc) return;
    if (mc.fuel_type) els.carFuel.value = mc.fuel_type;
    if (mc.consumption_l_per_100!=null) els.carCons.value = mc.consumption_l_per_100;
    if (mc.tank_capacity_l!=null) els.carTank.value = mc.tank_capacity_l;
    if (mc.current_level_l!=null) els.carCurrent.value = mc.current_level_l;
    if (mc.time_value_eur_per_hour!=null) els.carTimeVal.value = mc.time_value_eur_per_hour;
    if (mc.max_detour_min!=null) els.carDetour.value = mc.max_detour_min;
    preselect(els.carPrefBrands, mc.preferred_brands || []);
    loadDiscounts(els.discList, mc.discounts || []);
  }
  function applyMyCarToFilters(mc){
    if (!mc) mc = loadMyCar();
    if (mc.fuel_type){ els.fuel.value = mc.fuel_type; }
    if (mc.preferred_brands && mc.preferred_brands.length){
      preselect(els.brand, mc.preferred_brands.filter(b => (ALL_BRANDS||[]).includes(b)));
    }
    saveState();
  }

  // ===== Tabs =====
  function switchTab(name){
    const isStations = (name === 'stations');
    els.screenStations.classList.toggle('active', isStations);
    els.screenCar.classList.toggle('active', !isStations);
    els.tabStations.classList.toggle('active', isStations);
    els.tabCar.classList.toggle('active', !isStations);
  }
  els.tabStations.addEventListener('click', ()=> switchTab('stations'));
  els.tabCar.addEventListener('click', ()=> switchTab('car'));

  // ===== –°–ª—É—à–∞—Ç–µ–ª–∏ =====
  els.country.addEventListener('change', ()=> onCountryChange('', []));
  els.apply.addEventListener('click', applyFilters);
  els.nearby.addEventListener('click', findNearby);
  els.send.addEventListener('click', sendToBot);

  els.discAdd.addEventListener('click', ()=> els.discList.appendChild(makeDiscRow()));
  els.carSave.addEventListener('click', ()=>{
    const mc = readMyCarFromUI();
    saveMyCar(mc);
    setCarStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úî', 'ok');
  });
  els.carApplyToFilters.addEventListener('click', ()=>{
    applyMyCarToFilters();
    setCarStatus('–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ —Ñ–∏–ª—å—Ç—Ä–∞–º ‚úî', 'ok');
    switchTab('stations');
    applyFilters();
  });
  els.carReset.addEventListener('click', ()=>{
    localStorage.removeItem('fuelMyCar');
    writeMyCarToUI({});
    setCarStatus('–ü—Ä–æ—Ñ–∏–ª—å –æ—á–∏—â–µ–Ω', 'ok');
  });

  // ===== init =====
  const saved = restoreState();
  if (saved.f) els.fuel.value = saved.f;
  if (saved.l) els.limit.value = saved.l;

  const mcSaved = loadMyCar();
  writeMyCarToUI(mcSaved); // UI –ø–æ–ª–µ–π (–±—Ä–µ–Ω–¥—ã –∑–∞–ø–æ–ª–Ω–∏–º –ø–æ—Å–ª–µ meta)
  if (mcSaved.fuel_type) els.fuel.value = mcSaved.fuel_type;

  try{ const g = JSON.parse(localStorage.getItem('fuelFinderLastGeo')||'{}'); if(g.lat!=null&&g.lon!=null) setLastGeo(g.lat,g.lon);}catch{}
  if (tg) { registerFromWebApp(); }
  loadCountries().then(()=> {
    setOptions(els.carPrefBrands, ALL_BRANDS);
    preselect(els.carPrefBrands, mcSaved.preferred_brands || []);
    loadDiscounts(els.discList, mcSaved.discounts || []);
    if (mcSaved.preferred_brands && mcSaved.preferred_brands.length){
      preselect(els.brand, mcSaved.preferred_brands.filter(b => (ALL_BRANDS||[]).includes(b)));
    } else if (saved.brs) {
      preselect(els.brand, saved.brs);
    }
    preselect(els.fresh, saved.frs || []);
    applyFilters();
  });
})();
</script>
</body>
</html>
